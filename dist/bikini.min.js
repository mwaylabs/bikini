/*!
* Project:   Bikini - Everything a model needs
* Copyright: (c) 2015 M-Way Solutions GmbH.
* Version:   0.8.4
* Date:      Thu Jul 02 2015 17:42:27
* License:   https://raw.githubusercontent.com/mwaylabs/bikini/master/MIT-LICENSE.txt
*/
!function(a,b,c,d,e,f){var g;"undefined"!=typeof exports?g={LiveData:exports}:(g=a.Relution=a.Relution||{},g.LiveData={}),g.LiveData.Version=g.LiveData.version="0.8.4";var g;!function(a){var b;!function(b){var c=function(){function b(){}return b.log=function(b,c){a.LiveData.isDebugMode()&&console.log("%c%s","color: "+b+"; font-size: "+this.fontSize+";font-weight: normal;",c)},b.trace=function(a){this.log("#378c13",a)},b.warning=function(a){this.log("#e69138",a)},b.info=function(a){this.log("#00f",a)},b.error=function(a){this.log("#f00",a)},b.fontSize="12px",b}();b.Debug=c}(b=a.LiveData||(a.LiveData={}))}(g||(g={})),g.setDebug=function(a){return g.LiveData.DebugMode=a,new g.LiveData.Debug(a)},g.LiveData.isDebugMode=function(){return g.LiveData.DebugMode},g.LiveData.f=function(){},g.LiveData.create=function(a){return new this(a)},g.LiveData.design=function(a){var b=this.extend(a||{});return new b},g.LiveData.extend=b.Model.extend,g.LiveData.isCollection=function(a){return b.Collection.prototype.isPrototypeOf(a)},g.LiveData.isModel=function(a){return b.Model.prototype.isPrototypeOf(a)},g.LiveData.isEntity=function(a){return g.LiveData.Entity.prototype.isPrototypeOf(a)},g.LiveData.DATA={TYPE:{INTEGER:"integer",STRING:"string",TEXT:"text",DATE:"date",BOOLEAN:"boolean",FLOAT:"float",OBJECT:"object",ARRAY:"array",BINARY:"binary",OBJECTID:"objectid",NULL:"null"}},g.LiveData.http=b.ajax,b.ajax=function(a){var b=a&&a.ajax||g.LiveData.http;return b.apply(this,arguments)},g.LiveData.ajax=function(a,b){var d=this,f=arguments;return g.LiveData.Security.logon.apply(this,arguments).then(function(){var a=d.super_&&d.super_.ajax||g.LiveData.http,b=a.apply(d,f);if(b){var h=e.defer();return b.success(c.bind(h.resolve,h)),b.error(c.bind(h.reject,h)),h.promise.xhr=b,h.promise}return e.reject(new Error("ajax failed"))})},g.LiveData.sync=function(a,d,e){e=e||{};var f=e.store||this.store;if(e.credentials=e.credentials||this.credentials||f&&f.options&&f.options.credentials,g.LiveData.Debug.info("Relution.LiveData.sync "+a+" "+d.id),f&&f.sync){var h=f.ajax&&c.bind(f.ajax,f);return e.ajax=e.ajax||h||this.ajax||g.LiveData.ajax,e.promise=f.sync.apply(f,arguments),e.promise}var i=this.super_&&this.super_.sync||b.sync;return e.ajax=e.ajax||this.ajax||g.LiveData.http,i.apply(this,arguments)},g.LiveData._Object={_type:"Relution.LiveData._Object",_create:function(a){var b=function(){};return b.prototype=a,new b},include:function(a){for(var b in a){if(this.hasOwnProperty(b))throw g.LiveData.Exception.RESERVED_WORD.getException();this[b]=a[b]}return this},design:function(a){var b=this._create(this);return b.include(a),b},bindToCaller:function(a,b,c){return function(){if("function"!=typeof b||"object"!=typeof a)throw g.LiveData.Exception.INVALID_INPUT_PARAMETER.getException();return Array.isArray(c)?b.apply(a,c):b.call(a,c)}},handleCallback:function(a){var b=Array.prototype.slice.call(arguments,1);if(a){var c="object"==typeof a.target?a.target:this,d=a;if("function"==typeof a.action?d=a.action:"string"==typeof a.action&&(d=c[a.action]),"function"==typeof d)return this.bindToCaller(c,d,b)()}}},g.LiveData.ObjectID=function(a){g.LiveData.ObjectID.counter=g.LiveData.ObjectID.counter||parseInt(Math.random()*Math.pow(16,6)),g.LiveData.ObjectID.machineId=g.LiveData.ObjectID.machineId||parseInt(Math.random()*Math.pow(16,6)),g.LiveData.ObjectID.processId=g.LiveData.ObjectID.processId||parseInt(Math.random()*Math.pow(16,4)),this._ObjectID(a)},g.LiveData.ObjectID._looksLikeObjectID=function(a){return 24===a.length&&a.match(/^[0-9a-f]*$/)},c.extend(g.LiveData.ObjectID.prototype,{_str:"",_ObjectID:function(a){if(a){if(a=a.toLowerCase(),!g.LiveData.ObjectID._looksLikeObjectID(a))throw new Error("Invalid hexadecimal string for creating an ObjectID");this._str=a}else this._str=this._hexString(8,(new Date).getTime()/1e3)+this._hexString(6,g.LiveData.ObjectID.machineId)+this._hexString(4,g.LiveData.ObjectID.processId)+this._hexString(6,g.LiveData.ObjectID.counter++);return this._str},_hexString:function(a,b){b=b||parseInt(Math.random()*Math.pow(16,a));for(var c=b.toString(16);c.length<a;)c="0"+c;return c.substr(0,a)},toString:function(){return"ObjectID('"+this._str+"')"},equals:function(a){return a instanceof this._ObjectID&&this.valueOf()===a.valueOf()},clone:function(){return new g.LiveData.ObjectID(this._str)},typeName:function(){return"oid"},getTimestamp:function(){return 1e3*parseInt(this._str.substr(0,8),16)},getMachineId:function(){return parseInt(this._str.substr(8,6),16)},getProcessId:function(){return parseInt(this._str.substr(14,4),16)},getCounter:function(){return parseInt(this._str.substr(18,6),16)},valueOf:function(){return this._str},toJSON:function(){return this._str},toHexString:function(){return this._str},_selectorIsId:function(a){return"string"==typeof a||"number"==typeof a||a instanceof g.LiveData.ObjectId},_selectorIsIdPerhapsAsObject:function(a){return this._selectorIsId(a)||a&&"object"==typeof a&&a._id&&this._selectorIsId(a._id)&&1===c.size(a)},_idsMatchedBySelector:function(a){if(this._selectorIsId(a))return[a];if(!a)return null;if(c.has(a,"_id"))return this._selectorIsId(a._id)?[a._id]:a._id&&a._id.$in&&c.isArray(a._id.$in)&&!c.isEmpty(a._id.$in)&&c.all(a._id.$in,this._selectorIsId)?a._id.$in:null;if(a.$and&&c.isArray(a.$and))for(var b=0;b<a.$and.length;++b){var d=this._idsMatchedBySelector(a.$and[b]);if(d)return d}return null}}),g.LiveData.UniqueId=g.LiveData._Object.design({uuid:function(a,b){var c="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),d=[];b=b||c.length;var e;if(a)for(e=0;a>e;e++)d[e]=c[0|Math.random()*b];else{var f;for(d[8]=d[13]=d[18]=d[23]="-",d[14]="4",e=0;36>e;e++)d[e]||(f=0|16*Math.random(),d[e]=c[19===e?3&f|8:f])}return d.join("")}}),g.LiveData.Base64=g.LiveData._Object.design({type:"Relution.LiveData.Base64",_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encodeBinary:function(a){for(var b,c="",d=new Array(4),e=0,f=0;e<a.length;){b=new Array(3);for(var g=0;g<b.length;g++)e<a.length?b[g]=255&a.charCodeAt(e++):b[g]=0;switch(d[0]=b[0]>>2,d[1]=(3&b[0])<<4|b[1]>>4,d[2]=(15&b[1])<<2|b[2]>>6,d[3]=63&b[2],f=e-(a.length-1)){case 2:d[3]=64,d[2]=64;break;case 1:d[3]=64}for(g=0;g<d.length;g++)c+=this._keyStr.charAt(d[g])}return c},encode:function(a){var b,c,d,e,f,h,i,j="",k=0;for(a=g.LiveData.Cypher.utf8Encode(a);k<a.length;)b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),e=b>>2,f=(3&b)<<4|c>>4,h=(15&c)<<2|d>>6,i=63&d,isNaN(c)?h=i=64:isNaN(d)&&(i=64),j+=this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return j},binaryEncode:function(a){for(var b,c,d,e,f,g,h,i="",j=0;j<a.length;)b=a.charCodeAt(j++),c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i+=this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decode:function(a){var b,c,d,e,f,h,i,j="",k=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");k<a.length;)e=this._keyStr.indexOf(a.charAt(k++)),f=this._keyStr.indexOf(a.charAt(k++)),h=this._keyStr.indexOf(a.charAt(k++)),i=this._keyStr.indexOf(a.charAt(k++)),b=e<<2|f>>4,c=(15&f)<<4|h>>2,d=(3&h)<<6|i,j+=String.fromCharCode(b),64!==h&&(j+=String.fromCharCode(c)),64!==i&&(j+=String.fromCharCode(d));return g.LiveData.Cypher.utf8Decode(j)}}),g.LiveData.SHA256=g.LiveData._Object.design({type:"Relution.LiveData.SHA256",chrsz:8,hexcase:0,hash:function(a){return a=g.LiveData.Cypher.utf8Encode(a),this.binb2hex(this.coreSha256(this.str2binb(a),a.length*this.chrsz))},safeAdd:function(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c},S:function(a,b){return a>>>b|a<<32-b},R:function(a,b){return a>>>b},Ch:function(a,b,c){return a&b^~a&c},Maj:function(a,b,c){return a&b^a&c^b&c},Sigma0256:function(a){return this.S(a,2)^this.S(a,13)^this.S(a,22)},Sigma1256:function(a){return this.S(a,6)^this.S(a,11)^this.S(a,25)},Gamma0256:function(a){return this.S(a,7)^this.S(a,18)^this.R(a,3)},Gamma1256:function(a){return this.S(a,17)^this.S(a,19)^this.R(a,10)},coreSha256:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),p=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),q=new Array(64);for(a[b>>5]|=128<<24-b%32,a[(b+64>>9<<4)+15]=b,k=0;k<a.length;k+=16){for(c=p[0],d=p[1],e=p[2],f=p[3],g=p[4],h=p[5],i=p[6],j=p[7],l=0;64>l;l++)16>l?q[l]=a[l+k]:q[l]=this.safeAdd(this.safeAdd(this.safeAdd(this.Gamma1256(q[l-2]),q[l-7]),this.Gamma0256(q[l-15])),q[l-16]),m=this.safeAdd(this.safeAdd(this.safeAdd(this.safeAdd(j,this.Sigma1256(g)),this.Ch(g,h,i)),o[l]),q[l]),n=this.safeAdd(this.Sigma0256(c),this.Maj(c,d,e)),j=i,i=h,h=g,g=this.safeAdd(f,m),f=e,e=d,d=c,c=this.safeAdd(m,n);p[0]=this.safeAdd(c,p[0]),p[1]=this.safeAdd(d,p[1]),p[2]=this.safeAdd(e,p[2]),p[3]=this.safeAdd(f,p[3]),p[4]=this.safeAdd(g,p[4]),p[5]=this.safeAdd(h,p[5]),p[6]=this.safeAdd(i,p[6]),p[7]=this.safeAdd(j,p[7])}return p},str2binb:function(a){for(var b=[],c=(1<<this.chrsz)-1,d=0;d<a.length*this.chrsz;d+=this.chrsz)b[d>>5]|=(a.charCodeAt(d/this.chrsz)&c)<<24-d%32;return b},binb2hex:function(a){for(var b=this.hexcase?"0123456789ABCDEF":"0123456789abcdef",c="",d=0;d<4*a.length;d++)c+=b.charAt(a[d>>2]>>8*(3-d%4)+4&15)+b.charAt(a[d>>2]>>8*(3-d%4)&15);return c}}),g.LiveData.Cypher=g.LiveData._Object.design({type:"Relution.LiveData.Cypher",defaultDecoder:g.LiveData.Base64,defaultEncoder:g.LiveData.Base64,defaultHasher:g.LiveData.SHA256,decode:function(a,b){return b&&b.decode?b.decode(a):this.defaultDecoder.decode(a)},encode:function(a,b){return b&&b.encode?b.encode(a):this.defaultEncoder.encode(a)},hash:function(a,b){return b&&b.hash?b.hash(a):this.defaultHasher.hash(a)},utf8Encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b},utf8Decode:function(a){var b,c,d,e,f,g="";for(b=c=d=e=0;b<a.length;)c=a.charCodeAt(b),128>c?(g+=String.fromCharCode(c),b++):c>191&&224>c?(e=a.charCodeAt(b+1),g+=String.fromCharCode((31&c)<<6|63&e),b+=2):(e=a.charCodeAt(b+1),f=a.charCodeAt(b+2),g+=String.fromCharCode((15&c)<<12|(63&e)<<6|63&f),b+=3);return g}}),g.LiveData.Date={create:function(){var a=moment.apply(this,arguments);return c.extend(a,this)}},g.LiveData.URLUtil=g.LiveData._Object.design({getLocation:function(a){var b=document.createElement("a");return b.href=a||this.url,""===b.host&&(b.href=b.href),b},resolveLocation:function(a){return this.getLocation(a).toString()},hashLocation:function(a){return this._hashCode(this.resolveLocation(a))},_hashCode:function(){for(var a=0,b=0;b<arguments.length;++b)for(var c=arguments[b]||"",d=0,e=c.length;e>d;++d){var f=c.charCodeAt(d);a=(a<<5)-a+f,a|=0}return a}});var g;!function(a){var b;!function(a){var b=function(){function a(a){this.expression=f.eval(null,a,{resultType:"PATH"})||a}return a.prototype.evaluate=function(a,b){var c=f.eval(a,this.expression,b||{wrap:!1});return b||c!==!1||f.eval(a,this.expression,{resultType:"PATH",wrap:!1})?c:void 0},a}();a.JsonPath=b}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){var b=function(){function a(){}return a.prototype.visit=function(a){return this[a.type].apply(this,arguments)},a.prototype.logOp=function(a){return this[a.operation+"Op"].apply(this,arguments)},a}();a.FilterVisitorBase=b}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g,h=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c};!function(a){var b;!function(a){function b(a){return(new d).visit(a)}a.jsonFilter=b;var d=function(b){function d(){b.apply(this,arguments)}return h(d,b),d.prototype.containsString=function(b){var d=new a.JsonPath(b.fieldName),e=b.contains;return void 0===e||null===e?function(a){var b=d.evaluate(a);return void 0===b||null===b}:function(a){var b=d.evaluate(a);if(void 0===b||null===b)return!1;if(c.isArray(b)){for(var f=0;f<b.length;++f){var g=b[f];if(void 0!==g&&null!==g&&g.toString().indexOf(e)>=0)return!0}return!1}return void 0!==b&&null!==b&&b.toString().indexOf(e)>=0}},d.prototype.string=function(b){var d=new a.JsonPath(b.fieldName),e=b.value;return void 0===e||null===e?function(a){var b=d.evaluate(a);return void 0===b||null===b}:function(a){var e=d.evaluate(a);if(void 0===e||null===e)return!1;if(c.isArray(e)){for(var f=0;f<e.length;++f){var g=e[f];if(g==b.value)return!0}return!1}return e==b.value}},d.prototype.range=function(b){var c=new a.JsonPath(b.fieldName),d=b.min,e=b.max;return void 0===d||null===d?void 0===e||null===e?function(a){var b=c.evaluate(a);return!!b}:function(a){var b=c.evaluate(a);return!!b&&e>=b}:d===e?function(a){var b=c.evaluate(a);return!!b&&b==d}:void 0===e||null===e?function(a){var b=c.evaluate(a);return!!b&&b>=d}:function(a){var b=c.evaluate(a);return!!b&&e>=b&&b>=d}},d.prototype.longRange=function(a){return this.range(a)},d.prototype.dateRange=function(a){return this.range(a)},d.prototype.stringRange=function(a){return this.range(a)},d.prototype.doubleRange=function(a){return this.range(a)},d.prototype["boolean"]=function(b){var c=new a.JsonPath(b.fieldName),d=b.value;return function(a){var b=c.evaluate(a);return!!b===d}},d.prototype["enum"]=function(b){var c=new a.JsonPath(b.fieldName),d=b.values;return d?function(a){var b=c.evaluate(a);return d.indexOf(b)>=0}:function(a){var b=c.evaluate(a);return!b}},d.prototype.stringEnum=function(a){return this["enum"](a)},d.prototype.longEnum=function(a){return this["enum"](a)},d.prototype.stringMap=function(b){var c=new a.JsonPath(b.fieldName),d=b.key&&new a.JsonPath(b.key),e=b.value;return d||void 0!==e&&null!==e?d?void 0===e||null===e?function(a){var b=c.evaluate(a),e=d.evaluate(b);return void 0===e||null===e}:function(a){var b=c.evaluate(a),f=d.evaluate(b);return f==e}:function(a){var b=c.evaluate(a);return b==e}:function(a){var b=c.evaluate(a);return void 0===b||null===b}},d.prototype.like=function(b){var d=new a.JsonPath(b.fieldName),e=b.like;if(void 0===e||null===e)return function(a){var b=d.evaluate(a);return void 0===b||null===b};var f=e.replace(/%/g,".*"),g=new RegExp(f);return function(a){var b=d.evaluate(a);if(void 0===b||null===b)return!1;if(c.isArray(b)){for(var e=0;e<b.length;++e){var f=b[e];if(g.test(f))return!0}return!1}return g.test(b)}},d.prototype["null"]=function(b){var c=new a.JsonPath(b.fieldName);return b.isNull?function(a){var b=c.evaluate(a);return void 0===b||null===b}:function(a){var b=c.evaluate(a);return void 0!==b&&null!==b}},d.prototype.filters=function(a){for(var b=new Array(a.filters.length),c=0;c<b.length;++c)b[c]=this.visit(a.filters[c]);return b},d.prototype.andOp=function(a){var b=this.filters(a);return function(a){for(var c=0;c<b.length;++c){var d=b[c];if(!d(a))return!1}return!0}},d.prototype.orOp=function(a){var b=this.filters(a);return function(a){for(var c=0;c<b.length;++c){var d=b[c];if(d(a))return!0}return!1}},d.prototype.nandOp=function(a){var b=this.filters(a);return function(a){for(var c=0;c<b.length;++c){var d=b[c];if(!d(a))return!0}return!1}},d.prototype.norOp=function(a){var b=this.filters(a);return function(a){for(var c=0;c<b.length;++c){var d=b[c];if(d(a))return!1}return!0}},d}(a.FilterVisitorBase)}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){var b=function(){function a(a){this.sortFields=a&&a.sortFields}return a.prototype.fromJSON=function(a){this.sortFields=new Array(a.length);for(var b=a.length-1;b>=0;--b)this.sortFields[b]=(new d).fromJSON(a[b]);return this},a.prototype.merge=function(a){this.sortFields=this.sortFields.concat(a.sortFields)},a.prototype.optimize=function(){this.sortFields=c.unique(this.sortFields,!1,function(a){return a.name})},a}();a.SortOrder=b;var d=function(){function a(a){a&&(this.name=a.name,this.ascending=a.ascending)}return a.prototype.fromJSON=function(a){var b=a.length>0&&a.charAt(0);return this.name="+"===b||"-"===b?a.substring(1):a,this.ascending="-"!==b,this},a.prototype.toJSON=function(){return this.ascending?this.name:"-"+this.name},a}();a.SortField=d}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){function b(b){var e;"string"==typeof b?(e=new a.SortOrder,e.fromJSON.apply(e,arguments)):c.isArray(b)?(e=new a.SortOrder,e.fromJSON.call(e,b)):e=b;var f=new d(e);return c.bind(f.compare,f)}a.jsonCompare=b;var d=function(){function b(b){this.sortOrder=b,this.expressions=new Array(b.sortFields.length);for(var c=0;c<this.expressions.length;++c)this.expressions[c]=new a.JsonPath(b.sortFields[c].name)}return b.prototype.compare=function(a,c){for(var d=0;d<this.sortOrder.sortFields.length;++d){var e=this.expressions[d],f=e.evaluate(a),g=e.evaluate(c),h=b.compare1(f,g);if(0!==h)return this.sortOrder.sortFields[d].ascending?+h:-h}return 0},b.compare1=function(a,b){if(a&&b)if(Array.isArray(a)||Array.isArray(b))for(var c=Array.isArray(a)?a:[a],d=Array.isArray(b)?b:[b],e=Math.max(c.length,d.length),f=0;e>f;++f){var g=this.compare1(c[f],d[f]);if(0!==g)return g}else{if(b>a)return-1;if(a>b)return 1}else{if(b)return-1;if(a)return 1}return 0},b}()}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){var b=function(){function b(a){a&&(this.limit=a.limit,this.offset=a.offset,this.sortOrder=a.sortOrder,this.filter=a.filter,this.fields=a.fields)}return Object.defineProperty(b.prototype,"min",{get:function(){return 0|this.offset},set:function(a){var b=a&&0!==a?a:void 0;if(b!==this.offset){var c=this.max;this.offset=b,this.max=c}},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"max",{get:function(){return this.limit?this.limit+this.min:1/0},set:function(a){var b=a&&a!==1/0?a-this.min:void 0;if(b!==this.limit){var c=this.min;this.limit=b,this.min=c}},enumerable:!0,configurable:!0}),b.prototype.fromJSON=function(b){return this.limit=b.limit,this.offset=b.offset,this.sortOrder=b.sortOrder&&(new a.SortOrder).fromJSON(b.sortOrder),this.filter=b.filter,this.fields=b.fields,this},b.isAndFilter=function(a){return"logOp"===a.type&&"and"===a.operation},b.prototype.merge=function(b){this.min=Math.max(this.min,b.min),this.max=Math.min(this.max,b.max),this.sortOrder?b.sortOrder&&this.sortOrder.merge(b.sortOrder):this.sortOrder=b.sortOrder&&new a.SortOrder(b.sortOrder),this.filter?b.filter&&(this.filter={type:"logOp",operation:"and",filters:[this.filter,b.filter]}):this.filter=b.filter,this.fields?b.fields&&(this.fields=this.fields.concat(b.fields)):this.fields=b.fields},b.prototype.optimize=function(){if(this.sortOrder&&this.sortOrder.optimize(),this.filter&&b.isAndFilter(this.filter))for(var a=this.filter.filters,d=a.length;d>=0;)b.isAndFilter(a[d])?Array.prototype.splice.apply(a,Array.prototype.concat([d,1],a[d].filters)):--d;this.fields&&(Array.prototype.sort.apply(this.fields),this.fields=c.unique(this.fields,!0))},b}();a.GetQuery=b}(b=a.LiveData||(a.LiveData={}))}(g||(g={})),g.LiveData.Field=function(a){this.merge(a),this.initialize.apply(this,arguments)},g.LiveData.Field.extend=g.LiveData.extend,g.LiveData.Field.create=g.LiveData.create,g.LiveData.Field.design=g.LiveData.design,c.extend(g.LiveData.Field.prototype,g.LiveData._Object,{_type:"Relution.LiveData.Field",name:null,type:null,index:null,defaultValue:void 0,length:null,required:!1,persistent:!0,initialize:function(){},merge:function(a){a=c.isString(a)?{type:a}:a||{},this.name=c.isUndefined(a.name)?this.name:a.name,this.type=c.isUndefined(a.type)?this.type:a.type,this.index=c.isUndefined(a.index)?this.index:a.index,this.defaultValue=c.isUndefined(a.defaultValue)?this.defaultValue:a.defaultValue,this.length=c.isUndefined(a.length)?this.length:a.length,this.required=c.isUndefined(a.required)?this.required:a.required,this.persistent=c.isUndefined(a.persistent)?this.persistent:a.persistent},transform:function(a,b){b=b||this.type;try{if(c.isUndefined(a))return this.defaultValue;if(b===g.LiveData.DATA.TYPE.STRING||b===g.LiveData.DATA.TYPE.TEXT)return c.isObject(a)?JSON.stringify(a):c.isNull(a)?"null":a.toString();if(b===g.LiveData.DATA.TYPE.INTEGER)return parseInt(a);if(b===g.LiveData.DATA.TYPE.BOOLEAN)return a===!0||"true"===a;if(b===g.LiveData.DATA.TYPE.FLOAT)return parseFloat(a);if(b===g.LiveData.DATA.TYPE.OBJECT||b===g.LiveData.DATA.TYPE.ARRAY){if(!c.isObject(a))return c.isString(a)?JSON.parse(a):null}else if(b===g.LiveData.DATA.TYPE.DATE){if(!g.LiveData.Date.isPrototypeOf(a)){var d=a?g.LiveData.Date.create(a):null;return d&&d.isValid()?d:null}}else if(b===g.LiveData.DATA.TYPE.OBJECTID&&!g.LiveData.ObjectID.prototype.isPrototypeOf(a))return c.isString(a)?new g.LiveData.ObjectID(a):null;return a}catch(e){g.LiveData.Debug.error("Failed converting value! "+e.message)}},equals:function(a,b){var d=this.transform(a),e=this.transform(b);return this._equals(d,e,c.isArray(d))},isBinary:function(a){return"undefined"!=typeof Uint8Array&&a instanceof Uint8Array||a&&a.$Uint8ArrayPolyfill},detectType:function(a){return c.isNumber(a)?g.LiveData.DATA.TYPE.FLOAT:c.isString(a)?g.LiveData.DATA.TYPE.STRING:c.isBoolean(a)?g.LiveData.DATA.TYPE.BOOLEAN:c.isArray(a)?g.LiveData.DATA.TYPE.ARRAY:c.isNull(a)?g.LiveData.DATA.TYPE.NULL:c.isDate(a)||g.LiveData.Date.isPrototypeOf(a)?g.LiveData.DATA.TYPE.DATE:g.LiveData.ObjectID.prototype.isPrototypeOf(a)?g.LiveData.DATA.TYPE.OBJECTID:this.isBinary(a)?g.LiveData.DATA.TYPE.BINARY:g.LiveData.DATA.TYPE.OBJECT},typeOrder:function(a){switch(a){case g.LiveData.DATA.TYPE.NULL:return 0;case g.LiveData.DATA.TYPE.FLOAT:return 1;case g.LiveData.DATA.TYPE.STRING:return 2;case g.LiveData.DATA.TYPE.OBJECT:return 3;case g.LiveData.DATA.TYPE.ARRAY:return 4;case g.LiveData.DATA.TYPE.BINARY:return 5;case g.LiveData.DATA.TYPE.DATE:return 6}return-1},_equals:function(a,b,d){var e,f=this;if(a===b)return!0;if(!a||!b)return!1;if(!c.isObject(a)||!c.isObject(b))return!1;if(a instanceof Date&&b instanceof Date)return a.valueOf()===b.valueOf();if(this.isBinary(a)&&this.isBinary(b)){if(a.length!==b.length)return!1;for(e=0;e<a.length;e++)if(a[e]!==b[e])return!1;return!0}if(c.isFunction(a.equals))return a.equals(b);if(c.isArray(a)){if(!c.isArray(b))return!1;if(a.length!==b.length)return!1;for(e=0;e<a.length;e++)if(!f.equals(a[e],b[e],d))return!1;return!0}var g;if(d){var h=[];return c.each(b,function(a,b){h.push(b)}),e=0,g=c.all(a,function(a,c){return e>=h.length?!1:c!==h[e]?!1:f.equals(a,b[h[e]],d)?(e++,!0):!1}),g&&e===h.length}return e=0,g=c.all(a,function(a,g){return c.has(b,g)&&f.equals(a,b[g],d)?(e++,!0):!1}),g&&c.size(b)===e},_cmp:function(a,b){if(void 0===a)return void 0===b?0:-1;if(void 0===b)return 1;var c=0,d=this.detectType(a),e=this.detectType(b),f=this.typeOrder(d),h=this.typeOrder(e);if(f!==h)return h>f?-1:1;if(d!==e)throw new Error("Missing type coercion logic in _cmp");if(7===d&&(d=e=2,a=a.toHexString(),b=b.toHexString()),d===g.LiveData.DATA.TYPE.DATE&&(d=e=1,a=a.getTime(),b=b.getTime()),d===g.LiveData.DATA.TYPE.FLOAT)return a-b;if(e===g.LiveData.DATA.TYPE.STRING)return b>a?-1:a===b?0:1;if(d===g.LiveData.DATA.TYPE.OBJECT){var i=function(a){var b=[];for(var c in a)b.push(c),b.push(a[c]);return b};return this._cmp(i(a),i(b))}if(d===g.LiveData.DATA.TYPE.ARRAY)for(c=0;;c++){if(c===a.length)return c===b.length?0:-1;if(c===b.length)return 1;var j=this._cmp(a[c],b[c]);if(0!==j)return j}if(d===g.LiveData.DATA.TYPE.BINARY){if(a.length!==b.length)return a.length-b.length;for(c=0;c<a.length;c++){if(a[c]<b[c])return-1;if(a[c]>b[c])return 1}return 0}if(d===g.LiveData.DATA.TYPE.BOOLEAN)return a?b?0:1:b?-1:0;if(d===g.LiveData.DATA.TYPE.NULL)return 0;throw new Error("Unknown type to sort")}}),g.LiveData.Entity=function(a){var b=this.fields;this.fields={},this._mergeFields(b),a=a||{},a.fields&&this._mergeFields(a.fields),this.typeMapping=a.typeMapping||this.typeMapping;var c=a.collection,d=a.model||(c?c.prototype.model:null);this.idAttribute=a.idAttribute||this.idAttribute||(d?d.prototype.idAttribute:""),this._updateFields(this.typeMapping),this.initialize.apply(this,arguments)},g.LiveData.Entity.from=function(a,b){if(g.LiveData.Entity.prototype.isPrototypeOf(a))b&&b.typeMapping&&a._updateFields(b.typeMapping);else if(c.isFunction(a)&&g.LiveData.Entity.prototype.isPrototypeOf(a.prototype)){var d=a;a=new d(b)}else{"string"==typeof a&&(a={name:a});var e=g.LiveData.Entity.extend(a);a=new e(b)}return a},g.LiveData.Entity.extend=g.LiveData.extend,g.LiveData.Entity.create=g.LiveData.create,g.LiveData.Entity.design=g.LiveData.design,c.extend(g.LiveData.Entity.prototype,g.LiveData._Object,{_type:"Relution.LiveData.Entity",name:"",idAttribute:"",fields:{},initialize:function(){},getFields:function(){return this.fields},getField:function(a){return this.fields[a]},getFieldName:function(a){var b=this.getField(a);return b&&b.name?b.name:a},getKey:function(){return this.idAttribute||g.LiveData.Model.idAttribute},getKeys:function(){return this.splitKey(this.getKey())},splitKey:function(a){var b=[];return c.isString(a)&&c.each(a.split(","),function(a){var c=a.trim();c&&b.push(c)}),b},_mergeFields:function(a){c.isObject(this.fields)||(this.fields={});var b=this;c.isObject(a)&&c.each(a,function(a,c){b.fields[c]?b.fields[c].merge(a):b.fields[c]=new g.LiveData.Field(a)})},_updateFields:function(a){var b=this;c.each(this.fields,function(c,d){c.persistent?(c.name||(c.name=d),a&&a[c.type]&&(c.type=a[c.type])):delete b.fields[d]})},toAttributes:function(a,b,d){if(d=d||this.fields,a&&!c.isEmpty(d)){var e,f={};return c.each(d,function(b,d){e=c.isFunction(a.get)?a.get(b.name):a[b.name],f[d]=e}),f}return a},fromAttributes:function(a,b){if(b=b||this.fields,a&&!c.isEmpty(b)){var d={};return c.each(b,function(b,e){var f=c.isFunction(a.get)?a.get(e):a[e];f=b.transform(f),c.isUndefined(f)||(d[b.name]=f)}),d}return a},setId:function(a,b){if(a&&b){var d=this.getKey()||a.idAttribute;d&&(c.isFunction(a.set)?a.set(d,b):a[d]=b)}return a},getId:function(a){if(a){var b=this.getKey()||a.idAttribute;if(b)return c.isFunction(a.get)?a.get(b):a[b]}}}),g.LiveData.Security=g.LiveData._Object.design({logon:c.extend(function j(a){var b=a&&a.credentials,c=b&&b.type,d=c&&j[c];return d?d.apply(this,arguments):e.resolve()},{basic:function(a){var b=a.credentials,c=b.username&&g.LiveData.Base64.encode(encodeURIComponent(b.username+":"+(b.password||"")));return c&&(a.beforeSend=function(a){a.setRequestHeader("Authorization","Basic "+c)}),e.resolve()}})}),g.LiveData.Model=b.Model.extend({constructor:function(a,c){this.url&&"string"==typeof this.url&&"/"!==this.url.charAt(this.url.length-1)&&(this.url+="/"),this.init(a,c),b.Model.apply(this,arguments)}}),g.LiveData.Model.create=g.LiveData.create,g.LiveData.Model.design=g.LiveData.design,c.extend(g.LiveData.Model.prototype,g.LiveData._Object,{_type:"Relution.LiveData.Model",isModel:!0,entity:null,defaults:{},changedSinceSync:{},init:function(a,b){b=b||{},this.collection=b.collection||this.collection,this.idAttribute=b.idAttribute||this.idAttribute,this.store=this.store||(this.collection?this.collection.store:null)||b.store,this.store&&c.isFunction(this.store.initModel)&&this.store.initModel(this,b),this.entity=this.entity||(this.collection?this.collection.entity:null)||b.entity,this.entity&&(this.entity=g.LiveData.Entity.from(this.entity,{model:this.constructor,typeMapping:b.typeMapping}),this.idAttribute=this.entity.idAttribute||this.idAttribute),this.credentials=this.credentials||(this.collection?this.collection.credentials:null)||b.credentials,this.on("change",this.onChange,this),this.on("sync",this.onSync,this)},ajax:g.LiveData.ajax,sync:g.LiveData.sync,onChange:function(a,b){var d=a.changedAttributes();if(c.isObject(d))for(var e in d)this.changedSinceSync[e]=d[e]},onSync:function(a,b){this.changedSinceSync={}},getUrlRoot:function(){if(this.urlRoot)return c.isFunction(this.urlRoot)?this.urlRoot():this.urlRoot;if(this.collection)return this.collection.getUrlRoot();if(this.url){var a=c.isFunction(this.url)?this.url():this.url;return a&&this.id&&a.indexOf(this.id)>0?a.substr(0,a.indexOf(this.id)):a}}}),g.LiveData.Collection=b.Collection.extend({constructor:function(a){this.url&&"/"!==this.url.charAt(this.url.length-1)&&(this.url+="/"),this.init(a),b.Collection.apply(this,arguments)}}),g.LiveData.Collection.create=g.LiveData.create,g.LiveData.Collection.design=g.LiveData.design,c.extend(g.LiveData.Collection.prototype,g.LiveData._Object,{_type:"Relution.LiveData.Collection",isCollection:!0,model:g.LiveData.Model,entity:null,options:null,init:function(a){a=a||{},this.store=a.store||this.store||(this.model?this.model.prototype.store:null),this.entity=a.entity||this.entity||(this.model?this.model.prototype.entity:null),this.options=a.options||this.options;var b=this.entity||this.entityFromUrl(this.url);b&&(this.entity=g.LiveData.Entity.from(b,{model:this.model,typeMapping:a.typeMapping})),this._updateUrl(),this.store&&c.isFunction(this.store.initCollection)&&this.store.initCollection(this,a)},ajax:g.LiveData.ajax,sync:g.LiveData.sync,entityFromUrl:function(a){if(a){var b=document.createElement("a");b.href=a||this.url,""===b.host&&(b.href=b.href);var c=b.pathname.match(/([^\/]+)\/?$/);if(c&&c.length>1)return c[-1]}},sort:function(a){c.isObject(a&&a.sort)&&(this.comparator=g.LiveData.DataSelector.compileSort(a.sort)),b.Collection.prototype.sort.apply(this,arguments)},select:function(a){var b=a&&a.query?g.LiveData.DataSelector.create(a.query):null,c=g.LiveData.Collection.create(null,{model:this.model});return a&&a.sort&&(c.comparator=g.LiveData.DataSelector.compileSort(a.sort)),this.each(function(a){(!b||b.matches(a.attributes))&&c.add(a)}),c},destroy:function(a){a=a||{};var b=a.success;if(this.length>0){a.success=function(){0===this.length&&b&&b()};for(var c;c=this.first();)this.sync("delete",c,a),this.remove(c)}else b&&b()},destroyLocal:function(){var a=this.endpoint.localStore;return this.entity.name&&a.drop(this.entity.name),localStorage.setItem("__"+this.channel+"last_msg_time",""),this.store.endpoints={},this.reset()},save:function(){this.each(function(a){a.save()})},getUrlParams:function(a){a=a||this.getUrl();var b=a.match(/\?([^#]*)/),d={};return b&&b.length>1&&c.each(b[1].split("&"),function(a){var b=a.split("=");d[b[0]]=b[1]}),d},getUrl:function(a){return(c.isFunction(this.url)?this.url():this.url)||""},getUrlRoot:function(){var a=this.getUrl();return a?a.indexOf("?")>=0?a.substr(0,a.indexOf("?")):a:""},applyFilter:function(a){this.trigger("filter",this.filter(a))},_updateUrl:function(){var a=this.getUrlParams();if(this.options&&(this.url=this.getUrlRoot(),this.options.query&&(a.query=encodeURIComponent(JSON.stringify(this.options.query))),this.options.fields&&(a.fields=encodeURIComponent(JSON.stringify(this.options.fields))),this.options.sort&&(a.sort=encodeURIComponent(JSON.stringify(this.options.sort))),!c.isEmpty(a))){this.url+="?";var b=[];for(var d in a)b.push(d+(a[d]?"="+a[d]:""));this.url+=b.join("&")}},fetchMore:function(a){return this.syncContext?this.syncContext.fetchMore(this,a):e.reject(new Error("no context"))},fetchNext:function(a){return this.syncContext?this.syncContext.fetchNext(this,a):e.reject(new Error("no context"))},fetchPrev:function(a){return this.syncContext?this.syncContext.fetchPrev(this,a):e.reject(new Error("no context"));
}}),g.LiveData.DataSelector=g.LiveData._Object.design({_type:"Relution.LiveData.DataSelector",_selector:null,create:function(a){var b=this.design({_selector:null});return b.init(a),b},init:function(a){this._selector=this.compileSelector(a)},matches:function(a){return c.isFunction(this._selector)?this._selector(a):!1},hasOperators:function(a){var b;for(var c in a){var d="$"===c.substr(0,1);if(void 0===b)b=d;else if(b!==d)throw new Error("Inconsistent selector: "+a)}return!!b},compileSelector:function(a){if(c.isFunction(a))return function(b){return a.call(b)};if(this._selectorIsId(a))return function(b){var d=c.isFunction(b.getId)?b.getId():b._id||b.id;return g.LiveData.Field.prototype.equals(d,a)};if(!a||"_id"in a&&!a._id)return function(a){return!1};if(c.isBoolean(a)||c.isArray(a)||g.LiveData.Field.prototype.isBinary(a))throw new Error("Invalid selector: "+a);return this.compileDocSelector(a)},compileDocSelector:function(a){var b=g.LiveData.DataSelector,d=[];return c.each(a,function(a,e){if("$"===e.substr(0,1)){if(!c.has(b.LOGICAL_OPERATORS,e))throw new Error("Unrecognized logical operator: "+e);d.push(b.LOGICAL_OPERATORS[e](a))}else{var f=b._makeLookupFunction(e),g=b.compileValueSelector(a);d.push(function(a){var b=f(a);return c.any(b,g)})}}),function(a){var b=c.isFunction(a.getData)?a.getData():a;return c.all(d,function(a){return a(b)})}},compileValueSelector:function(a){var b=g.LiveData.DataSelector;if(null===a)return function(a){return b._anyIfArray(a,function(a){return null===a})};if(!c.isObject(a))return function(c){return b._anyIfArray(c,function(b){return b===a})};if(c.isRegExp(a))return function(d){return c.isUndefined(d)?!1:b._anyIfArray(d,function(b){return a.test(b)})};if(c.isArray(a))return function(d){return c.isArray(d)?b._anyIfArrayPlus(d,function(c){return b._equal(a,c)}):!1};if(this.hasOperators(a)){var d=[];return c.each(a,function(e,f){if(!c.has(b.VALUE_OPERATORS,f))throw new Error("Unrecognized operator: "+f);d.push(b.VALUE_OPERATORS[f](e,a.$options))}),function(a){return c.all(d,function(b){return b(a)})}}return function(c){return b._anyIfArray(c,function(c){return b._equal(a,c)})}},_makeLookupFunction:function(a){var b,d,e,f=a.indexOf(".");if(-1===f)b=a;else{b=a.substr(0,f);var g=a.substr(f+1);d=this._makeLookupFunction(g),e=/^\d+(\.|$)/.test(g)}return function(a){if(null===a)return[void 0];var f=a[b];return d?c.isArray(f)&&0===f.length?[void 0]:((!c.isArray(f)||e)&&(f=[f]),Array.prototype.concat.apply([],c.map(f,d))):[f]}},_anyIfArray:function(a,b){return c.isArray(a)?c.any(a,b):b(a)},_anyIfArrayPlus:function(a,b){return b(a)?!0:c.isArray(a)&&c.any(a,b)},_selectorIsId:function(a){return c.isString(a)||c.isNumber(a)},_equal:function(a,b){return g.LiveData.Field.prototype._equals(a,b,!0)},_cmp:function(a,b){return g.LiveData.Field.prototype._cmp(a,b)},LOGICAL_OPERATORS:{$and:function(a){if(!c.isArray(a)||c.isEmpty(a))throw new Error("$and/$or/$nor must be nonempty array");var b=c.map(a,g.LiveData.DataSelector.compileDocSelector);return function(a){return c.all(b,function(b){return b(a)})}},$or:function(a){if(!c.isArray(a)||c.isEmpty(a))throw new Error("$and/$or/$nor must be nonempty array");var b=c.map(a,g.LiveData.DataSelector.compileDocSelector);return function(a){return c.any(b,function(b){return b(a)})}},$nor:function(a){if(!c.isArray(a)||c.isEmpty(a))throw new Error("$and/$or/$nor must be nonempty array");var b=c.map(a,g.LiveData.DataSelector.compileDocSelector);return function(a){return c.all(b,function(b){return!b(a)})}},$where:function(a){if(!c.isFunction(a)){var b=a;a=function(){return b}}return function(b){return a.call(b)}}},VALUE_OPERATORS:{$in:function(a){if(!c.isArray(a))throw new Error("Argument to $in must be array");return function(b){return g.LiveData.DataSelector._anyIfArrayPlus(b,function(b){return c.any(a,function(a){return g.LiveData.DataSelector._equal(a,b)})})}},$all:function(a){if(!c.isArray(a))throw new Error("Argument to $all must be array");return function(b){return c.isArray(b)?c.all(a,function(a){return c.any(b,function(b){return g.LiveData.DataSelector._equal(a,b)})}):!1}},$lt:function(a){return function(b){return g.LiveData.DataSelector._anyIfArray(b,function(b){return g.LiveData.DataSelector._cmp(b,a)<0})}},$lte:function(a){return function(b){return g.LiveData.DataSelector._anyIfArray(b,function(b){return g.LiveData.DataSelector._cmp(b,a)<=0})}},$gt:function(a){return function(b){return g.LiveData.DataSelector._anyIfArray(b,function(b){return g.LiveData.DataSelector._cmp(b,a)>0})}},$gte:function(a){return function(b){return g.LiveData.DataSelector._anyIfArray(b,function(b){return g.LiveData.DataSelector._cmp(b,a)>=0})}},$ne:function(a){return function(b){return!g.LiveData.DataSelector._anyIfArrayPlus(b,function(b){return g.LiveData.DataSelector._equal(b,a)})}},$nin:function(a){if(!c.isArray(a))throw new Error("Argument to $nin must be array");var b=this.VALUE_OPERATORS.$in(a);return function(a){return void 0===a?!0:!b(a)}},$exists:function(a){return function(b){return a===(void 0!==b)}},$mod:function(a){var b=a[0],c=a[1];return function(a){return g.LiveData.DataSelector._anyIfArray(a,function(a){return a%b===c})}},$size:function(a){return function(b){return c.isArray(b)&&a===b.length}},$type:function(a){return function(b){return c.isUndefined(b)?!1:g.LiveData.DataSelector._anyIfArray(b,function(b){return g.LiveData.Field.prototype.detectType(b)===a})}},$regex:function(a,b){if(c.isUndefined(b)){if(/[^gim]/.test(b))throw new Error("Only the i, m, and g regexp options are supported");var d=c.isRegExp(a)?a.source:a;a=new RegExp(d,b)}else c.isRegExp(a)||(a=new RegExp(a));return function(b){return c.isUndefined(b)?!1:g.LiveData.DataSelector._anyIfArray(b,function(b){return a.test(b)})}},$options:function(a){return function(a){return!0}},$elemMatch:function(a){var b=g.LiveData.DataSelector.compileDocSelector(a);return function(a){return c.isArray(a)?c.any(a,function(a){return b(a)}):!1}},$not:function(a){var b=g.LiveData.DataSelector.compileDocSelector(a);return function(a){return!b(a)}}},compileSort:function(a){var b=[];if(c.isArray(a))for(var d=0;d<a.length;d++)"string"==typeof a[d]?b.push({lookup:this._makeLookupFunction(a[d]),ascending:!0}):b.push({lookup:this._makeLookupFunction(a[d][0]),ascending:"desc"!==a[d][1]});else{if("object"!=typeof a)throw new Error("Bad sort specification: ",JSON.stringify(a));for(var e in a)b.push({lookup:this._makeLookupFunction(e),ascending:a[e]>=0})}if(0===b.length)return function(){return 0};var f=function(a,b){var d,e=!0;return c.each(a,function(a){c.isArray(a)||(a=[a]),c.isArray(a)&&0===a.length&&(a=[void 0]),c.each(a,function(a){if(e)d=a,e=!1;else{var c=g.LiveData.DataSelector._cmp(d,a);(b&&c>0||!b&&0>c)&&(d=a)}})}),d};return function(a,c){a=a.attributes?a.attributes:a,c=c.attributes?c.attributes:c;for(var d=0;d<b.length;++d){var e=b[d],h=f(e.lookup(a),e.ascending),i=f(e.lookup(c),e.ascending),j=g.LiveData.DataSelector._cmp(h,i);if(0!==j)return e.ascending?j:-j}return 0}}}),g.LiveData.SqlSelector=g.LiveData.DataSelector.design({_type:"Relution.LiveData.SqlSelector",_selector:null,_query:null,_entity:null,create:function(a,b){var c=this.extend({_entity:b,_selector:null,_query:null});return c.init(a),c},init:function(a){this._selector=this.compileSelector(a),this._query=this.buildSqlQuery(a)},buildStatement:function(a){return this._query},buildSqlQuery:function(a,b){if(a instanceof Function)return"";if(c.isString(a))return a;if(!a||"_id"in a&&!a._id)return"1=2";if(c.isBoolean(a)||c.isArray(a)||g.LiveData.DataField.isBinary(a))throw new Error("Invalid selector: "+a);return this.buildSqlWhere(a)()},buildSqlWhere:function(a){var b=this,d=[];return c.each(a,function(a,e){if("$"===e.substr(0,1))d.push(b.buildLogicalOperator(e,a));else{var f=b.buildLookup(e),g=b.buildValueSelector(a);c.isFunction(g)&&d.push(function(){return g(f)})}}),function(){var a="";return c.each(d,function(d){c.isFunction(d)&&(a+=d.call(b))}),a}},buildValueSelector:function(a){var b=this;if(null===a)return function(a){return a+" IS NULL"};if(!c.isObject(a))return function(c){return c+" = "+b.buildValue(a)};if(c.isRegExp(a)){var d=a.toString(),e=d.match(/\/[\^]?([^^.*$'+()]*)[\$]?\//);if(e&&e.length>1){var f=d.indexOf("/^")<0?"%":"",g=d.indexOf("$/")<0?"%":"";return function(a){return a+' LIKE "'+f+e[1]+g+'"'}}return null}if(c.isArray(a))return null;if(this.hasOperators(a)){var h=[];return c.each(a,function(a,d){if(!c.has(b.VALUE_OPERATORS,d))throw new Error("Unrecognized operator: "+d);h.push(b.VALUE_OPERATORS[d](a,b))}),function(a){return b.LOGICAL_OPERATORS.$and(h,a)}}return function(c){return c+" = "+b.buildValue(a)}},buildLookup:function(a){var b=this._entity?this._entity.getField(a):null;return a=b&&b.name?b.name:a,'"'+a+'"'},buildValue:function(a){return c.isString(a)?'"'+a.replace(/"/g,'""')+'"':a},buildLogicalOperator:function(a,b){if(c.has(this.LOGICAL_OPERATORS,a)){if(!c.isArray(b)||c.isEmpty(b))throw new Error("$and/$or/$nor must be nonempty array");var d=c.map(b,this.buildSqlWhere,this),e=this;return function(b){return e.LOGICAL_OPERATORS[a](d,b)}}throw new Error("Unrecognized logical operator: "+a)},LOGICAL_OPERATORS:{$and:function(a,b){var d="",e=0;return c.each(a,function(a){var c=null!==a?a(b):"";c&&(e++,d+=d?" AND "+c:c)}),e>1?"( "+d+" )":d},$or:function(a,b){var d="",e=!1;return c.each(a,function(a){var c=null!==a?a(b):"";e|=!c,d+=d&&c?" OR "+c:c}),e?"":"( "+d+" )"},$nor:function(a,b){var d="",e=!1;return c.each(a,function(a){var c=null!==a?a(b):"";e|=!c,d+=d&&c?" OR "+c:c}),e?"":"NOT ( "+d+" )"}},VALUE_OPERATORS:{$in:function(a){return null},$all:function(a){return null},$lt:function(a,b){return function(c){return c+" < "+b.buildValue(a)}},$lte:function(a,b){return function(c){return c+" <= "+b.buildValue(a)}},$gt:function(a,b){return function(c){return c+" > "+b.buildValue(a)}},$gte:function(a,b){return function(c){return c+"">""+b.buildValue(a)}},$ne:function(a,b){return function(c){return c+" <> "+b.buildValue(a)}},$nin:function(a){return null},$exists:function(a,b){return function(a){return a+" IS NOT NULL"}},$mod:function(a){return null},$size:function(a){return null},$type:function(a){return null},$regex:function(a,b){return null},$options:function(a){return null},$elemMatch:function(a){return null},$not:function(a,b){var c=b.buildSqlWhere(a);return function(a){return"NOT ("+c(a)+")"}}}});var g;!function(a){var d;!function(d){var f=function(){function f(a){this.options=c.extend({name:"",entities:{},typeMapping:function(){var a={};return a[d.DATA.TYPE.OBJECTID]=d.DATA.TYPE.STRING,a[d.DATA.TYPE.DATE]=d.DATA.TYPE.STRING,a[d.DATA.TYPE.BINARY]=d.DATA.TYPE.TEXT,a}()},a),this.setEntities(this.options.entities)}return f.prototype.setEntities=function(a){this.entities={};for(var b in a){var c=d.Entity.from(a[b],{store:this,typeMapping:this.options.typeMapping});c.name=c.name||b;var e=c.collection||d.Collection.extend({model:d.Model.extend({})}),f=e.prototype.model;e.prototype.entity=f.prototype.entity=b,e.prototype.store=f.prototype.store=this,c.idAttribute=c.idAttribute||f.prototype.idAttribute,this.entities[b]=c}},f.prototype.getEntity=function(a){if(a){var b=a.entity||a,d=c.isString(b)?b:b.name;if(d)return this.entities[d]||(b&&b.name?b:{name:d})}},f.prototype.getCollection=function(a){return c.isString(a)&&(a=this.entities[a]),a&&a.collection?d.Collection.prototype.isPrototypeOf(a.collection)?a.collection:new a.collection:void 0},f.prototype.createModel=function(a,b){if(c.isString(a)&&(a=this.entities[a]),a&&a.collection){var d=a.collection.model||a.collection.prototype.model;if(d)return new d(b)}},f.prototype.getArray=function(a){return c.isArray(a)?a:d.isCollection(a)?a.models:c.isObject(a)?[a]:[]},f.prototype.getDataArray=function(a){var d=[];if(c.isArray(a)||b.Collection.prototype.isPrototypeOf(a))c.each(a,function(a){var b=this.getAttributes(a);b&&d.push(b)});else{var e=this.getAttributes(a);e&&d.push(this.getAttributes(e))}return d},f.prototype.getAttributes=function(a){return b.Model.prototype.isPrototypeOf(a)?a.attributes:c.isObject(a)?a:null},f.prototype.initModel=function(a){},f.prototype.initCollection=function(a){},f.prototype.initEntity=function(a){},f.prototype.sync=function(a,b,c){return e.reject(new Error("not implemented!"))},f.prototype.fetch=function(a,b){if(!a||a.models||a.attributes||b||(b=a),a&&(a.models||a.attributes)||!b||!b.entity||(a=this.getCollection(b.entity)),a&&a.fetch){var d=c.extend({},b||{},{store:this});return a.fetch(d)}},f.prototype.create=function(a,b,d){if(!a||a.models||d||(b=a,d=b),a&&a.models||!d||!d.entity||(a=this.getCollection(d.entity)),a&&a.create){var e=c.extend({},d||{},{store:this});a.create(b,e)}},f.prototype.save=function(a,b,d){if(!a||a.attributes||d||(b=a,d=b),a&&a.attributes||!d||!d.entity||(a=this.createModel(d.entity)),a&&a.save){var e=c.extend({},d||{},{store:this});a.save(b,e)}},f.prototype.destroy=function(a,b){if(a&&a.destroy){var d=c.extend({},b||{},{store:this});a.destroy(d)}},f.prototype._checkEntity=function(b,c){if(!d.isEntity(c)){var e=f.CONST.ERROR_NO_ENTITY;return a.LiveData.Debug.error(e),this.handleError(b,e),!1}return!0},f.prototype._checkData=function(b,d){if(!(c.isArray(d)&&0!==d.length||c.isObject(d))){var e=f.CONST.ERROR_NO_DATA;return a.LiveData.Debug.error(e),this.handleError(b,e),!1}return!0},f.prototype.handleSuccess=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];a.success&&this.handleCallback.apply(this,[a.success].concat(b)),a.finish&&this.handleCallback.apply(this,[a.finish].concat(b))},f.prototype.handleError=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];a.error&&this.handleCallback.apply(this,[a.error].concat(b)),a.finish&&this.handleCallback.apply(this,[a.finish].concat(b))},f.extend=d.extend,f.create=d.create,f.design=d.design,f.CONST={ERROR_NO_ENTITY:"No valid entity specified. ",ERROR_NO_DATA:"No data passed. ",ERROR_LOAD_DATA:"Error while loading data from store. ",ERROR_SAVE_DATA:"Error while saving data to the store. ",ERROR_LOAD_IDS:"Error while loading ids from store. ",ERROR_SAVE_IDS:"Error while saving ids to the store. "},f}();d.Store=f,c.extend(f.prototype,b.Events,d._Object)}(d=a.LiveData||(a.LiveData={}))}(g||(g={}));var g,h=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c};!function(a){var b;!function(b){var d=function(d){function f(){d.apply(this,arguments),this.ids={}}return h(f,d),f.prototype.sync=function(a,d,f){f=c.defaults({entity:d.entity},f);var g,h=this,i=h.getEntity(f);if(i&&d){var j=d.id||("create"===a?(new b.ObjectID).toHexString():null);switch(g=i.fromAttributes(f.attrs||d.attributes),a){case"patch":case"update":case"create":"create"!==a&&(g=c.extend(h._getItem(i,j)||{},g)),d.id!==j&&d.idAttribute&&(g[d.idAttribute]=j),h._setItem(i,j,g);break;case"delete":h._removeItem(i,j);break;case"read":if(j)g=h._getItem(i,j);else{g=[];var k=h._getItemIds(i);for(j in k){var l=h._getItem(i,j);l&&g.push(l)}f.syncContext&&(g=f.syncContext.processAttributes(g))}break;default:return}}return e.resolve(i.toAttributes(g)).then(function(a){return a?h.handleSuccess(f,a)||a:h.handleError(f,b.Store.CONST.ERROR_NO_ENTITY)||e.reject(b.Store.CONST.ERROR_NO_ENTITY)})},f.prototype.drop=function(a){var c=this.getEntity(a);if(c&&c.name){for(var d=this._findAllKeys(c),e=0;e<d.length;e++)localStorage.removeItem(d[e]);localStorage.removeItem("__ids__"+c.name),this.handleSuccess(a)}else this.handleError(a,b.Store.CONST.ERROR_NO_ENTITY)},f.prototype._getKey=function(a,b){return"_"+a.name+"_"+b},f.prototype._getItem=function(c,d){var e;if(c&&d)try{e=JSON.parse(localStorage.getItem(this._getKey(c,d))),e?c.setId(e,d):this._delItemId(c,d)}catch(f){a.LiveData.Debug.error(b.Store.CONST.ERROR_LOAD_DATA+f.message)}return e},f.prototype._setItem=function(c,d,e){if(c&&d&&e)try{localStorage.setItem(this._getKey(c,d),JSON.stringify(e)),this._addItemId(c,d)}catch(f){a.LiveData.Debug.error(b.Store.CONST.ERROR_SAVE_DATA+f.message)}},f.prototype._removeItem=function(a,b){a&&b&&(localStorage.removeItem(this._getKey(a,b)),this._delItemId(a,b))},f.prototype._addItemId=function(a,b){var c=this._getItemIds(a);b in c||(c[b]="",this._saveItemIds(a,c))},f.prototype._delItemId=function(a,b){var c=this._getItemIds(a);b in c&&(delete c[b],this._saveItemIds(a,c))},f.prototype._findAllKeys=function(a){var b=[],c=this._getKey(a,"");if(c)for(var d,e=localStorage.length,f=0;e>f;f++)d=localStorage.key(f),d&&d===c&&b.push(d);return b},f.prototype._getItemIds=function(c){try{var d="__ids__"+c.name;return this.ids[c.name]||(this.ids[c.name]=JSON.parse(localStorage.getItem(d))||{}),this.ids[c.name]}catch(e){a.LiveData.Debug.error(b.Store.CONST.ERROR_LOAD_IDS+e.message)}},f.prototype._saveItemIds=function(c,d){try{var e="__ids__"+c.name;localStorage.setItem(e,JSON.stringify(d))}catch(f){a.LiveData.Debug.error(b.Store.CONST.ERROR_SAVE_IDS+f.message)}},f}(b.Store);b.LocalStorageStore=d}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g,h=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c};!function(b){var d;!function(d){var f=function(f){function g(a){f.call(this,c.extend({name:"relution-livedata",size:1048576,version:"1.0",typeMapping:function(){var a={};return a[d.DATA.TYPE.OBJECTID]=d.DATA.TYPE.STRING,a[d.DATA.TYPE.DATE]=d.DATA.TYPE.STRING,a[d.DATA.TYPE.OBJECT]=d.DATA.TYPE.TEXT,a[d.DATA.TYPE.ARRAY]=d.DATA.TYPE.TEXT,a[d.DATA.TYPE.BINARY]=d.DATA.TYPE.TEXT,a}(),sqlTypeMapping:function(){var a={};return a[d.DATA.TYPE.STRING]="varchar(255)",a[d.DATA.TYPE.TEXT]="text",a[d.DATA.TYPE.OBJECT]="text",a[d.DATA.TYPE.ARRAY]="text",a[d.DATA.TYPE.FLOAT]="float",a[d.DATA.TYPE.INTEGER]="integer",a[d.DATA.TYPE.DATE]="varchar(255)",a[d.DATA.TYPE.BOOLEAN]="boolean",a}()},a)),this.db=null,this.dataField={name:"data",type:"text",required:!0},this.idField={name:"id",type:"string",required:!0};var e=this;this._openDb({error:function(a){b.LiveData.Debug.error(a),e.trigger("error",a)}})}return h(g,f),g.prototype.sync=function(a,b,d){d=d||{};var f=this,g=e.defer(),h=c.extend({entity:b.entity||d.entity},d||{},{success:function(a){var b=f.handleSuccess(d,a)||a;return g.resolve(b),b},error:function(a){var b=f.handleError(d,a);return b?(g.resolve(b),b):void g.reject(a)}});switch(a){case"create":f._checkTable(h,function(){f._insertOrReplace(b,h)});break;case"update":case"patch":f._checkTable(h,function(){f._insertOrReplace(b,h)});break;case"delete":f._checkTable(h,function(){f._delete(b,h)});break;case"read":f._checkTable(h,function(){f._select(b,h)})}return g.promise},g.prototype.select=function(a){this._select(null,a)},g.prototype.drop=function(a){this._dropTable(a)},g.prototype.createTable=function(a){this._createTable(a)},g.prototype.execute=function(a){this._executeSql(a)},g.prototype._openDb=function(b){var c,d;if(!this.db)try{if(a.openDatabase){if(this.db=a.openDatabase(this.options.name,"","",this.options.size),this.entities)for(var e in this.entities)this._createTable({entity:this.entities[e]})}else c="Your browser does not support WebSQL databases."}catch(f){d=f}this.db?this.options.version&&this.db.version!==this.options.version?this._updateDb(b):this.handleSuccess(b,this.db):2===d||"2"===d?this._updateDb(b):(!c&&d&&(c=d),this.handleSuccess(b,c))},g.prototype._updateDb=function(d){var e,f,g=this;try{this.db||(this.db=a.openDatabase(this.options.name,"","",this.options.size));try{var h=this._sqlUpdateDatabase(this.db.version,this.options.version);this.db.changeVersion(this.db.version,this.options.version,function(a){c.each(h,function(c){b.LiveData.Debug.info("sql statement: "+c),f=c,a.executeSql(c)})},function(a){g.handleError(d,a,f)},function(){g.handleSuccess(d,g.db)})}catch(i){e=i.message,b.LiveData.Debug.error("webSql change version failed, DB-Version: "+this.db.version)}}catch(i){e=i.message}e&&this.handleError(d,e)},g.prototype._sqlUpdateDatabase=function(a,b){var c=[];if(this.entities)for(var d in this.entities){var e=this.entities[d];c.push(this._sqlDropTable(e.name)),c.push(this._sqlCreateTable(e))}return c},g.prototype._sqlDropTable=function(a){return"DROP TABLE IF EXISTS '"+a+"'"},g.prototype._isAutoincrementKey=function(a,b){if(a&&b){var c=this.getField(a,b);return c&&c.type===d.DATA.TYPE.INTEGER}},g.prototype._sqlPrimaryKey=function(a,b){if(b&&1===b.length){var c=this.getField(a,b[0]);return this._isAutoincrementKey(a,b[0])?c.name+" INTEGER PRIMARY KEY ASC AUTOINCREMENT UNIQUE":this._dbAttribute(c)+" PRIMARY KEY ASC UNIQUE"}return""},g.prototype._sqlConstraint=function(a,b){return b&&b.length>1?"PRIMARY KEY ("+b.join(",")+") ON CONFLICT REPLACE":""},g.prototype._sqlCreateTable=function(a){var b=this,d=a.getKeys(),e=1===d.length?this._sqlPrimaryKey(a,d):"",f=d.length>1?this._sqlConstraint(a,d):a.constraint||"",g="",h=this.getFields(a);c.each(h,function(a){if(!e||a!==h[d[0]]){var c=b._dbAttribute(a);c&&(g+=(g?", ":"")+c)}}),g||(g=this._dbAttribute(this.dataField));var i="CREATE TABLE IF NOT EXISTS '"+a.name+"' (";return i+=e?e+", ":"",i+=g,i+=f?", "+f:"",i+=");"},g.prototype._sqlDelete=function(a,b){var c="DELETE FROM '"+b.name+"'",d=this._sqlWhere(a,b)||this._sqlWhereFromData(a,b);return d&&(c+=" WHERE "+d),c+=a.and?" AND "+a.and:""},g.prototype._sqlWhere=function(a,b){this._selector=null;var e="";return c.isString(a.where)?e=a.where:c.isObject(a.where)&&(this._selector=d.SqlSelector.create(a.where,b),e=this._selector.buildStatement()),e},g.prototype._sqlWhereFromData=function(a,b){var d=this,e=[];if(a&&a.models&&b&&b.idAttribute){var f,g=b.idAttribute,h=this.getField(b,g);if(c.each(a.models,function(a){f=a.id,c.isUndefined(f)||e.push(d._sqlValue(f,h))}),e.length>0)return g+" IN ("+e.join(",")+")"}return""},g.prototype._sqlSelect=function(a,b){if(a.syncContext){var c="SELECT ";return c+="*",c+=" FROM '"+b.name+"'"}var c="SELECT ";a.fields?a.fields.length>1?c+=a.fields.join(", "):1===a.fields.length&&(c+=a.fields[0]):c+="*",c+=" FROM '"+b.name+"'",a.join&&(c+=" JOIN "+a.join),a.leftJoin&&(c+=" LEFT JOIN "+a.leftJoin);var d=this._sqlWhere(a,b)||this._sqlWhereFromData(a,b);return d&&(c+=" WHERE "+d),a.order&&(c+=" ORDER BY "+a.order),a.limit&&(c+=" LIMIT "+a.limit),a.offset&&(c+=" OFFSET "+a.offset),c},g.prototype._sqlValue=function(a,b){var c=b&&b.type?b.type:d.Field.prototype.detectType(a);return c===d.DATA.TYPE.INTEGER||c===d.DATA.TYPE.FLOAT?a:c===d.DATA.TYPE.BOOLEAN?a?"1":"0":c===d.DATA.TYPE.NULL?"NULL":(a=d.Field.prototype.transform(a,d.DATA.TYPE.STRING),a=a.replace(/"/g,'""'),'"'+a+'"')},g.prototype._dbAttribute=function(a){if(a&&a.name){var b=this.options.sqlTypeMapping[a.type],c=a.required?" NOT NULL":"";if(b)return a.name+" "+b.toUpperCase()+c}},g.prototype._dropTable=function(a){var b=this.getEntity(a);if(b.db=null,this._checkDb(a)&&b){var c=this._sqlDropTable(b.name);this._executeTransaction(a,[c])}},g.prototype._createTable=function(a){var b=this.getEntity(a);if(b.db=this.db,this._checkDb(a)&&this._checkEntity(a,b)){var c=this._sqlCreateTable(b);this._executeTransaction(a,[c])}},g.prototype._checkTable=function(a,b){var c=this.getEntity(a);c&&!c.db?this._createTable({success:function(){b()},error:function(b){this.handleError(a,b)},entity:c}):b()},g.prototype._insertOrReplace=function(a,b){var e=this.getEntity(b),f=d.isCollection(a)?a.models:[a];if(this._checkDb(b)&&this._checkEntity(b,e)&&this._checkData(b,f)){for(var g=this._isAutoincrementKey(e,e.getKey()),h=[],i="INSERT OR REPLACE INTO '"+e.name+"' (",j=0;j<f.length;j++){var k=f[j],l="";g||k.id||!k.idAttribute||k.set(k.idAttribute,(new d.ObjectID).toHexString());var m,n,o=b.attrs||k.attributes;if(c.isEmpty(e.fields)?(m=[k.id,JSON.stringify(o)],n=[this.idField.name,this.dataField.name]):(o=e.fromAttributes(o),m=c.values(o),n=c.keys(o)),m.length>0){var p=new Array(m.length).join("?,")+"?",q="'"+n.join("','")+"'";l+=i+q+") VALUES ("+p+");",h.push({statement:l,arguments:m})}}this._executeTransaction(b,h,a.toJSON())}},g.prototype._select=function(a,e){var f=this.getEntity(e);if(this._checkDb(e)&&this._checkEntity(e,f)){var g,h,i=!d.isModel(a);i?h=[]:e.models=[a];var j=this._sqlSelect(e,f),k=this;this.db.readTransaction(function(a){var d=j.statement||j,e=j.arguments;g=d,b.LiveData.Debug.info("sql statement: "+d),e&&b.LiveData.Debug.trace("arguments: "+JSON.stringify(e)),a.executeSql(d,e,function(a,b){for(var d=b.rows.length,e=0;d>e;e++){var g,j=b.rows.item(e);if(c.isEmpty(f.fields)&&k._hasDefaultFields(j))try{g=JSON.parse(j.data)}catch(l){k.trigger("error",l);continue}else g=f.toAttributes(j);if(!k._selector||k._selector.matches(g)){if(!i){h=g;break}h.push(g)}}},function(a,c){b.LiveData.Debug.error("webSql error: "+c.message)})},function(a){b.LiveData.Debug.error("WebSql Syntax Error: "+a.message),k.handleError(e,a.message,g)},function(){h?(e.syncContext&&(h=e.syncContext.processAttributes(h)),k.handleSuccess(e,h)):k.handleError(e,"no result")})}},g.prototype._delete=function(a,b){var c=this.getEntity(b),e=d.isCollection(a)?a.models:[a];if(this._checkDb(b)&&this._checkEntity(b,c)){b.models=e;var f=this._sqlDelete(b,c);this._executeTransaction(b,[f],a.toJSON())}},g.prototype._executeSql=function(a){a.sql&&this._executeTransaction(a,[a.sql])},g.prototype._executeTransaction=function(a,d,e){var f,g;if(this._checkDb(a)){var h=this;try{this.db.transaction(function(a){c.each(d,function(c){var d=c.statement||c,e=c.arguments;g=d,b.LiveData.Debug.info("sql statement: "+d),e&&b.LiveData.Debug.trace("    arguments: "+JSON.stringify(e)),a.executeSql(d,e)})},function(c){b.LiveData.Debug.error(c.message),h.handleError(a,c.message,g)},function(){h.handleSuccess(a,e)})}catch(i){b.LiveData.Debug.error(i.message),f=i}}f&&this.handleError(a,f,g)},g.prototype._hasDefaultFields=function(a){return c.every(c.keys(a),function(a){return a===this.idField.name||a===this.dataField.name},this)},g.prototype._checkDb=function(a){if(!this.db){var c="db handler not initialized.";return b.LiveData.Debug.error(c),this.handleError(a,c),!1}return!0},g.prototype.getFields=function(a){if(c.isEmpty(a.fields)){var b={},d=a.idAttribute||"id";return b[d]=this.idField,b.data=this.dataField,b}return a.fields},g.prototype.getField=function(a,b){return this.getFields(a)[b]},g}(d.Store);d.WebSqlStore=f}(d=b.LiveData||(b.LiveData={}))}(g||(g={}));var g,h=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c};!function(a){var b;!function(b){var d=function(d){function f(e){d.call(this,c.extend({localStore:b.WebSqlStore,useLocalStore:!0,useSocketNotify:!0,useOfflineChanges:!0,socketPath:"",typeMapping:function(){var a={};return a[b.DATA.BINARY]="text",a[b.DATA.TEXT]="string",a}()},e)),this.endpoints={},this.options.useSocketNotify&&"object"!=typeof io&&(a.LiveData.Debug.warning("Socket.IO not present !!"),this.options.useSocketNotify=!1)}return h(f,d),f.prototype.initEndpoint=function(c,d){a.LiveData.Debug.info("Relution.LiveData.SyncStore.initEndpoint");var e=c.getUrlRoot(),f=this.getEntity(c.entity);if(e&&f){var g=f.name,h=b.URLUtil.hashLocation(e),i=f.credentials||c.credentials||this.options.credentials,j=i&&i.username?i.username:"",k=g+j+h;c.channel=k;var l=this.endpoints[h];if(!l){var m=b.URLUtil.getLocation(e);l={},l.model=d,l.isConnected=!1,l.urlRoot=e,l.host=m.protocol+"//"+m.host,l.path=m.pathname,l.entity=f,l.channel=k,l.credentials=i,l.socketPath=this.options.socketPath,l.localStore=this.createLocalStore(l),l.messages=this.createMsgCollection(l),l.socket=this.createSocket(l,g),l.info=this.fetchServerInfo(l),this.endpoints[h]=l}return l}},f.prototype.initModel=function(b){a.LiveData.Debug.trace("Relution.LiveData.SyncStore.initModel"),b.endpoint=this.initEndpoint(b,b.constructor)},f.prototype.initCollection=function(b){a.LiveData.Debug.trace("Relution.LiveData.SyncStore.initCollection"),b.endpoint=this.initEndpoint(b,b.model)},f.prototype.getEndpoint=function(a){if(a){var c=b.URLUtil.hashLocation(a);return this.endpoints[c]}},f.prototype.createLocalStore=function(a){if(this.options.useLocalStore){var d={};return d[a.entity.name]=c.extend(new b.Entity(a.entity),{name:a.channel,idAttribute:a.model.prototype.idAttribute}),this.options.localStore.create({entities:d})}},f.prototype.createMsgCollection=function(a){if(this.options.useOfflineChanges){var c="msg-"+a.channel,d={};d[c]=new b.Entity({name:c,idAttribute:"id"});var e=b.Collection.design({entity:c,store:this.options.localStore.create({entities:d})});return a.isConnected&&this._sendMessages(a),e}},f.prototype.createSocket=function(d,e){if(a.LiveData.Debug.trace("Relution.LiveData.SyncStore.createSocket"),this.options.useSocketNotify&&d&&d.socketPath){var f=this,g=d.host,h=d.path,i=b.URLUtil.getLocation(g);""===i.port&&("https:"===i.protocol?g+=":443":"http:"===i.protocol&&(g+=":80")),h=d.socketPath;var j=h&&0===h.indexOf("/")?h.substr(1):h,k={resource:j};return this.options.socketQuery&&(k.query=this.options.socketQuery),d.socket=io.connect(g,k),d.socket.on("connect",function(){return f._bindChannel(d,e),f.onConnect(d).done()}),d.socket.on("disconnect",function(){return a.LiveData.Debug.info("socket.io: disconnect"),f.onDisconnect(d).done()}),d.socket.on(d.channel,c.bind(this.onMessage,this,d)),d.socket}},f.prototype._bindChannel=function(b,c){a.LiveData.Debug.trace("Relution.LiveData.SyncStore._bindChannel");if(b&&b.socket){var d=b.channel,e=b.socket,f=this.getLastMessageTime(d);c=c||b.entity.name,e.emit("bind",{entity:c,channel:d,time:f})}},f.prototype.getLastMessageTime=function(a){if(this.lastMesgTime){if(void 0!==this.lastMesgTime[a])return this.lastMesgTime[a]}else this.lastMesgTime={};var b=0|localStorage.getItem("__"+a+"lastMesgTime")||0;return this.lastMesgTime[a]=b,b},f.prototype.setLastMessageTime=function(a,b){(!b||b>this.getLastMessageTime(a))&&(localStorage.setItem("__"+a+"lastMesgTime",b),this.lastMesgTime[a]=b)},f.prototype.onConnect=function(a){if(a.isConnected)return e.resolve();a.isConnected=!0;var b=this;return this.fetchChanges(a).then(function(){return b._sendMessages(a)})["finally"](function(){a.isConnected&&b.trigger("connect:"+a.channel)})},f.prototype.onDisconnect=function(a){if(!a.isConnected)return e.resolve();a.isConnected=!1;var b=this;return e.fcall(function(){a.socket&&a.socket.socket&&a.socket.socket.onDisconnect()})["finally"](function(){a.isConnected||b.trigger("disconnect:"+a.channel)})},f.prototype._fixMessage=function(a,b){b.data&&!b.data[a.entity.idAttribute]&&b.data._id?b.data[a.entity.idAttribute]=b.data._id:!b.data&&"delete"===b.method&&b[a.entity.idAttribute]&&(b.data={},b.data[a.entity.idAttribute]=b[a.entity.idAttribute])},f.prototype.onMessage=function(a,b){var d=this;if(!b||!b.method)return e.reject("no message or method given");this._fixMessage(a,b);var f,g=a.channel;if(a.localStore){var h=c.defaults({store:a.localStore,entity:a.entity},d.options),i=new a.model(b.data,c.extend({parse:!0},h));f=a.localStore.sync(b.method,i,c.extend(h,{merge:"patch"===b.method,success:function(a){d.trigger("sync:"+g,b)},error:function(a){d.trigger("error:"+g,a)}}))}else f=e.fcall(function(){return d.trigger("sync:"+g,b)||b});return f.then(function(a){return b.time&&d.setLastMessageTime(g,b.time),a}).thenResolve(b)},f.prototype.sync=function(d,f,g){a.LiveData.Debug.trace("Relution.LiveData.SyncStore.sync"),g=g||{};try{var h=f.endpoint||this.getEndpoint(f.getUrlRoot());if(!h)throw new Error("no endpoint");if(b.isCollection(f)){if("read"===d){var i=g.syncContext;i||(i=new b.SyncContext(g,f.options,this.options),g.syncContext=i),f.syncContext!==i&&(f.syncContext&&f.stopListening(this,"sync:"+h.channel),f.listenTo(this,"sync:"+h.channel,c.bind(i.onMessage,i,this,f)),f.syncContext=i)}}else b.isModel(f)&&("create"!==d||f.id||f.set(f.idAttribute,(new b.ObjectID).toHexString()));var j=h.channel,k=this.getLastMessageTime(j);if("read"===d&&h.localStore&&k&&!g.reset){var l=c.clone(g);l.store=h.localStore,l.entity=h.entity,delete l.success,delete l.error;
var m=this;return h.localStore.sync(d,f,l).then(function(a){return a=m.handleSuccess(g,a)||a,h.socket?a:m.fetchChanges(h)["catch"](function(a){m.trigger("error:"+j,a)}).thenResolve(a)},function(){return m._addMessage(d,f,g,h)})}return this._addMessage(d,f,g,h)}catch(n){return e.reject(this.handleError(g,n)||n)}},f.prototype._addMessage=function(a,b,d,f){var g=this;if(a&&b){var h=b.changedSinceSync,i=null,j=!0;switch(a){case"update":case"create":i=d.attrs||b.toJSON();break;case"patch":if(c.isEmpty(h))return;i=b.toJSON({attrs:h});break;case"delete":break;default:j=!1}var k,l={_id:b.id,id:b.id,method:a,data:i,channel:f.channel},m=e.resolve(l);return j&&(k=this.storeMessage(f,m),m=k.then(function(a){return a.attributes})),m.then(function(a){return g._emitMessage(f,a,d,b,k)})}},f.prototype._emitMessage=function(a,b,c,d,f){var g=this,h=a.channel,i=this._ajaxMessage(a,b,c,d),j=i;return f&&(j=j.then(function(c){return g.removeMessage(a,b,f).then(c,function(a){return g.trigger("error:"+h,a),c}).thenResolve(c)},function(a){return!a.responseText&&g.options.useOfflineChanges?e.resolve(b.data):e.reject.apply(e,arguments)})),j=this._applyResponse(j,a,b,c,d),j["finally"](function(){return i.then(function(){return a.isConnected?void 0:g.onConnect(a)},function(b){return!b.responseText&&a.isConnected?g.onDisconnect(a):void 0})})},f.prototype._ajaxMessage=function(d,e,f,g){f=f||{};var h=f.url;if(!h&&(h=d.urlRoot,e.id&&"create"!==e.method&&(h+=("/"===h.charAt(h.length-1)?"":"/")+e.id),"read"===e.method&&b.isCollection(g))){var i=c.isFunction(g.url)?g.url():g.url,j=i.lastIndexOf("?");j>=0&&(h+=i.substr(j))}return a.LiveData.Debug.trace("ajaxMessage "+e.method+" "+h),g.sync(e.method,g,{url:h,attrs:e.data,store:{},credentials:f.credentials,error:f.error})},f.prototype._applyResponse=function(a,d,f,g,h){var i=(d.channel,this);return a.then(function(a){if(a||"delete"!==f.method||(a=f.data),a){var g=[];if("read"!==f.method)g.push(i.onMessage(d,a===f.data?f:c.defaults({data:a},f)));else if(b.isCollection(h)&&c.isArray(a)){var j={};h.models.forEach(function(a){j[a.id]=a}),a.forEach(function(a){if(a){var b=a[d.entity.idAttribute]||a._id,e=j[b];e?(delete j[b],c.isEqual(c.pick.call(e,e.attributes,Object.keys(a)),a)||g.push(i.onMessage(d,{id:b,method:"update",data:a}))):g.push(i.onMessage(d,{id:b,method:"create",data:a}))}}),Object.keys(j).forEach(function(a){var b=j[a];g.push(i.onMessage(d,{id:a,method:"delete",data:b.attributes}))})}else for(var k=c.isArray(a)?a:[a],l=0;l<k.length;l++)a=k[l],a&&g.push(i.onMessage(d,{id:a[d.entity.idAttribute]||a._id,method:"update",data:a}));return e.all(g).thenResolve(a)}}).then(function(a){return i.handleSuccess(g,a)||a},function(a){return i.handleError(g,a)||e.reject(a)})},f.prototype.fetchChanges=function(a){var b=this,c=a?a.channel:"",d=b.getLastMessageTime(c);if(a&&a.urlRoot&&c&&d){var f=new a.messages.constructor;return f.fetch({url:a.urlRoot+"changes/"+d,store:{},success:function(c,d,e){return f.each(function(c){var d=c.attributes;b.onMessage(a,d)}),d||e.xhr},credentials:a.credentials})}return e.resolve()},f.prototype.fetchServerInfo=function(a){var c=this;if(a&&a.urlRoot){var d=new b.Model,e=c.getLastMessageTime(a.channel),f=a.urlRoot;return"/"!==f.charAt(f.length-1)&&(f+="/"),d.fetch({url:f+"info",success:function(b,f,g){if(!e&&d.get("time")&&c.setLastMessageTime(a.channel,d.get("time")),!a.socketPath&&d.get("socketPath")){a.socketPath=d.get("socketPath");var h=d.get("entity")||a.entity.name;c.options.useSocketNotify&&(a.socket=c.createSocket(a,h))}return f||g.xhr},credentials:a.credentials})}},f.prototype._sendMessages=function(c){if(!c||!c.messages)return e.resolve();var d=this;return c.messages.fetch().then(function f(g){if(c.messages.models.length<=0)return g;var h=c.messages.models[0],i=h.attributes,j=h.get("channel");if(!i||!j)return h.destroy();d._fixMessage(c,i);var k={urlRoot:c.urlRoot,store:{}},l={store:c.localStore},m=new b.Model(i.data,{idAttribute:c.entity.idAttribute,entity:c.entity});return a.LiveData.Debug.info("sendMessage "+m.id),d._applyResponse(d._ajaxMessage(c,i,k,m),c,i,k,m)["catch"](function(a){return c.localStore?(i.id&&(k.url=k.urlRoot+("/"===k.urlRoot.charAt(k.urlRoot.length-1)?"":"/")+i.id),m.fetch(k).then(function(a){return m.save(a,l)},function(a){var b=a&&a.status;switch(b){case 404:case 401:case 410:return m.destroy(l);default:return e.reject(a)}})):e.reject(a)}).then(function(){return h.destroy()}).then(function(a){return f(a)})})},f.prototype.storeMessage=function(b,c){return c.then(function(c){var d,e=b.messages.modelId(c);a.LiveData.Debug.info("storeMessage "+e);var f=e&&b.messages.get(e);return f?d={merge:!0}:f=new b.messages.model(c,{collection:b.messages,store:b.messages.store}),f.save(c,d).thenResolve(f)})},f.prototype.removeMessage=function(b,c,d){return d.then(function(d){if(!d){var f=b.messages.modelId(c);if(!f)return e.resolve();d=b.messages.get(f),d||(d=new b.messages.model({_id:c._id,id:c.id},{collection:b.messages,store:b.messages.store}))}return a.LiveData.Debug.trace("removeMessage "+d.id),d.destroy()})},f.prototype.clear=function(a){if(a){var b=this.getEndpoint(a.getUrlRoot());b&&(b.messages&&b.messages.destroy(),a.reset(),this.setLastMessageTime(b.channel,""))}},f}(b.Store);b.SyncStore=d}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){var b=function(){function b(){for(var b=this,c=[],d=0;d<arguments.length;d++)c[d-0]=arguments[d];this.getQuery=new a.GetQuery,c.forEach(function(c){c&&b.getQuery.merge((new a.GetQuery).fromJSON(c))}),this.getQuery.optimize(),this.pageSize=this.getQuery.limit,this.compareFn=this.getQuery.sortOrder&&a.jsonCompare(this.getQuery.sortOrder),this.filterFn=this.getQuery.filter&&a.jsonFilter(this.getQuery.filter)}return b.prototype.fetchMore=function(b,c){c=c||{},c.syncContext=this;var d=this.getQuery,e=new a.GetQuery(d);e.offset=(0|e.offset)+b.models.length,e.limit=c.pageSize||this.pageSize||e.limit;var f=c.success,g=c.error;return c.success=function(a){return c.success=f,c.error=g,a&&(a.length>0?(c.syncContext.compareFn&&(c.at=c.syncContext.insertionPoint(a[0],b.models)),a=b.add(a,c)||a,d.limit=b.models.length,c.more=!0,delete c.end):(d.limit=void 0,c.end=!0,delete c.more)),c.syncContext.getQuery=d,c.success&&(a=c.success.call(this,b,a,c)||a),c.finish&&(a=c.finish.call(this,b,a,c)||a),a},c.error=function(a){return c.success=f,c.error=g,c.syncContext.getQuery=d,c.error&&(a=c.error.call(this,b,a,c)||a),c.finish&&(a=c.finish.call(this,b,a,c)||a),a},this.getQuery=e,b.sync(c.method||"read",b,c)},b.prototype.fetchRange=function(b,c){c=c||{},c.syncContext=this;var d=this.getQuery,e=new a.GetQuery(d);c.offset>=0?e.offset=c.offset:c.offset<0&&(e.offset=void 0),c.limit>0?e.limit=c.limit+1:c.limit<=0&&(e.limit=void 0);var f=c.success,g=c.error;return c.success=function(a){return c.success=f,c.error=g,a&&(a.length>0?(c.next=e.limit&&a.length>=e.limit,c.next&&(a.length=a.length-1),a=b.reset(a,c)||a):delete c.next,c.prev=e.offset>0),c.success&&(a=c.success.call(this,b,a,c)||a),c.finish&&(a=c.finish.call(this,b,a,c)||a),a},c.error=function(a){return c.success=f,c.error=g,c.syncContext.getQuery=d,c.error&&(a=c.error.call(this,b,a,c)||a),c.finish&&(a=c.finish.call(this,b,a,c)||a),a},this.getQuery=e,b.sync(c.method||"read",b,c)},b.prototype.fetchNext=function(a,b){return b=b||{},b.limit=b.pageSize||this.pageSize||this.getQuery.limit,b.offset=(0|this.getQuery.offset)+a.models.length,this.fetchRange(a,b)},b.prototype.fetchPrev=function(a,b){return b=b||{},b.limit=b.pageSize||this.pageSize||this.getQuery.limit,b.offset=(0|this.getQuery.offset)-b.limit,this.fetchRange(a,b)},b.prototype.filterAttributes=function(a){return this.filterFn?a.filter(this.filterFn):a},b.prototype.sortAttributes=function(a){return this.compareFn?a.sort(this.compareFn):a},b.prototype.rangeAttributes=function(a){return this.getQuery.offset>0&&a.splice(0,this.getQuery.offset),this.getQuery.limit<a.length&&(a.length=this.getQuery.limit),a},b.prototype.processAttributes=function(a){return a=this.filterAttributes(a),a=this.sortAttributes(a),a=this.rangeAttributes(a)},b.prototype.onMessage=function(a,b,c){var d={collection:b,entity:b.entity,merge:"patch"===c.method,parse:!0,fromMessage:!0},e=b.modelId(c.data);if("all"===e)return void b.reset(c.data||{},d);var f=e&&b.get(e);switch(c.method){case"create":case"update":if(!f){if(f=new d.collection.model(c.data,d),this.filterFn&&!this.filterFn(f.attributes))break;if(f.validationError)b.trigger("invalid",this,f.validationError,d);else{var g=b.models.length;this.compareFn&&g>0&&(d.at=g=this.insertionPoint(f.attributes,b.models)),this.getQuery.offset>0&&!(g>0)||g>=this.getQuery.limit||(b.add(f,d),this.getQuery.limit&&b.models.length>=this.getQuery.limit&&b.remove(b.models[b.models.length-1],d))}break}case"patch":f&&(f.set(c.data,d),this.filterFn&&!this.filterFn(f.attributes)&&b.remove(f,d));break;case"delete":f&&b.remove(f,d)}},b.prototype.insertionPoint=function(a,b){if(void 0!==this.lastInsertionPoint){var c=Math.max(0,this.lastInsertionPoint),d=Math.min(b.length,this.lastInsertionPoint+3);if(d-c>1){var e=this.insertionPointBinarySearch(a,b,c,d);return e>=d?e<b.length&&(e=this.insertionPointBinarySearch(a,b,e,b.length)):c>e&&e>=0&&(e=this.insertionPointBinarySearch(a,b,0,e)),this.lastInsertionPoint=e,e}}return this.lastInsertionPoint=this.insertionPointBinarySearch(a,b,0,b.length),this.lastInsertionPoint},b.prototype.insertionPointBinarySearch=function(a,b,c,d){var e=c+d>>1,f=this.compareFn(a,b[e].attributes);return 1>=d-c?0>f?e:e+1:0>f?this.insertionPointBinarySearch(a,b,c,e):f>0?this.insertionPointBinarySearch(a,b,e,d):e},b}();a.SyncContext=b}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var i=null;a.Relution&&(i=a.Bikini=g.LiveData,i.BikiniStore=g.LiveData.SyncStore)}(this,Backbone,_,$,Q,jsonPath);
//# sourceMappingURL=bikini.map