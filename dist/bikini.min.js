!function(a,b,c,d,e,f){var g;"undefined"!=typeof exports?g={LiveData:exports}:(g=a.Relution=a.Relution||{},g.LiveData={}),g.LiveData.Version=g.LiveData.version="0.8.4";var g;!function(a){function b(){return a.Debug.enabled}function d(b){return a.Debug.enabled=b,a.Debug}var e=function(){function a(a,b){void 0===a&&(a=!1),void 0===b&&(b="12px"),this.enabled_=a,this.fontSize_=b,this.reset()}return a.STUB=function(){},a.prototype.reset=function(){this.enabled_?(this.log=c.bind(console.log,console,"%c%s"),this.trace=c.bind(console.trace,console,"%c%s","color: #378c13; font-size: "+this.fontSize_+";font-weight: normal;"),this.debug=c.bind(console.trace,console,"%c%s","color: #008c13; font-size: "+this.fontSize_+";font-weight: normal;"),this.warn=c.bind(console.warn,console,"%c%s","color: #e69138; font-size: "+this.fontSize_+";font-weight: normal;"),this.info=c.bind(console.info,console,"%c%s","color: #00f; font-size: "+this.fontSize_+";font-weight: normal;"),this.error=c.bind(console.error,console,"%c%s","color: #f00; font-size: "+this.fontSize_+";font-weight: normal;")):(this.log=a.STUB,this.trace=a.STUB,this.debug=a.STUB,this.warn=a.STUB,this.info=a.STUB,this.error=a.STUB),this.warning=this.warn},Object.defineProperty(a.prototype,"enabled",{get:function(){return this.enabled_},set:function(a){this.enabled_!==a&&(this.enabled_=a,this.reset())},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"fontSize",{get:function(){return this.fontSize_},set:function(a){this.fontSize_!==a&&(this.fontSize_=a,this.reset())},enumerable:!0,configurable:!0}),a.DebugConsole=a,a}();a.DebugConsole=e,a.Debug=new e,a.isDebugMode=b,a.setDebug=d;var f;!function(b){b.Debug=a.Debug}(f=a.LiveData||(a.LiveData={}))}(g||(g={}));var g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};!function(a){function b(b,c){if((void 0===a.assertions?a.isDebugMode():a.assertions)&&!b()){var d=new e(c||b.toSource());throw a.isDebugMode()?a.Debug.error("Assertion failed: "+d.message,d):console.error("Assertion failed: "+d.message,d),d}}function d(a,d){return b(function(){return c.isError(a)},d),a}var e=function(a){function b(b){a.call(this,b)}return h(b,a),b}(Error);a.AssertionError=e,a.assert=b,a.assertIsError=d}(g||(g={})),g.LiveData.f=function(){},g.LiveData.create=function(a){return new this(a)},g.LiveData.design=function(a){var b=this.extend(a||{});return new b},g.LiveData.extend=b.Model.extend,g.LiveData.bareboneOptions=Object.freeze({barebone:!0,add:!1,remove:!1,merge:!1,sort:!1,silent:!0}),g.LiveData.http=b.ajax,b.ajax=function(a){var b=a&&a.ajax||g.LiveData.http;return b.apply(this,arguments)},g.LiveData.ajax=function(a){var b=this,c=arguments,d=a.success;delete a.success;var f=a.error;delete a.error,a.method=a.type;var h=g.LiveData.Security.logon.apply(this,arguments).then(function(){var i=b.super_&&b.super_.ajax||g.LiveData.http,j=i.apply(b,c);if(!j)return e.reject(new Error("ajax failed"));if(h.xhr=j,a.xhr=j,e.isPromiseAlike(j)&&"function"==typeof j["catch"])return j.then(function(a){return d&&d(a.data,a.status,a),e.resolve(a.data)},function(a){return a.responseText=a.statusText,a.responseJSON=a.data,f&&f(a,a.statusText,a.data),e.reject(a)});var k=e.defer();return j.success(function(a,b,c){var e;return d&&(e=d.apply(this,arguments)),k.resolve(a),e}),j.error(function(a,b,c){var d;return f&&(d=f.apply(this,arguments)),k.reject(a),d}),k.promise});return h},g.LiveData.sync=function(a,d,e){e=e||{};var f=e.store||this.store;if(e.credentials=e.credentials||this.credentials||f&&f.options&&f.options.credentials,g.LiveData.Debug.info("Relution.LiveData.sync "+a+" "+d.id),f&&f.sync){var h=f.ajax&&c.bind(f.ajax,f);return e.ajax=e.ajax||h||this.ajax||g.LiveData.ajax,e.promise=f.sync.apply(f,arguments),e.promise}var i=this.super_&&this.super_.sync||b.sync;return e.ajax=e.ajax||this.ajax||g.LiveData.http,i.apply(this,arguments)},g.LiveData._Object={_type:"Relution.LiveData._Object",_create:function(a){var b=function(){};return b.prototype=a,new b},include:function(a){for(var b in a){if(this.hasOwnProperty(b))throw g.LiveData.Exception.RESERVED_WORD.getException();this[b]=a[b]}return this},design:function(a){var b=this._create(this);return b.include(a),b},bindToCaller:function(a,b,c){return function(){if("function"!=typeof b||"object"!=typeof a)throw g.LiveData.Exception.INVALID_INPUT_PARAMETER.getException();return Array.isArray(c)?b.apply(a,c):b.call(a,c)}},handleCallback:function(a){var b=Array.prototype.slice.call(arguments,1);if(a){var c="object"==typeof a.target?a.target:this,d=a;if("function"==typeof a.action?d=a.action:"string"==typeof a.action&&(d=c[a.action]),"function"==typeof d)return this.bindToCaller(c,d,b)()}}},g.LiveData.ObjectID=function(a){g.LiveData.ObjectID.counter=g.LiveData.ObjectID.counter||parseInt(Math.random()*Math.pow(16,6)),g.LiveData.ObjectID.machineId=g.LiveData.ObjectID.machineId||parseInt(Math.random()*Math.pow(16,6)),g.LiveData.ObjectID.processId=g.LiveData.ObjectID.processId||parseInt(Math.random()*Math.pow(16,4)),this._ObjectID(a)},g.LiveData.ObjectID._looksLikeObjectID=function(a){return 24===a.length&&a.match(/^[0-9a-f]*$/)},c.extend(g.LiveData.ObjectID.prototype,{_str:"",_ObjectID:function(a){if(a){if(a=a.toLowerCase(),!g.LiveData.ObjectID._looksLikeObjectID(a))throw new Error("Invalid hexadecimal string for creating an ObjectID");this._str=a}else this._str=this._hexString(8,(new Date).getTime()/1e3)+this._hexString(6,g.LiveData.ObjectID.machineId)+this._hexString(4,g.LiveData.ObjectID.processId)+this._hexString(6,g.LiveData.ObjectID.counter++);return this._str},_hexString:function(a,b){b=b||parseInt(Math.random()*Math.pow(16,a));for(var c=b.toString(16);c.length<a;)c="0"+c;return c.substr(0,a)},toString:function(){return"ObjectID('"+this._str+"')"},equals:function(a){return a instanceof this._ObjectID&&this.valueOf()===a.valueOf()},clone:function(){return new g.LiveData.ObjectID(this._str)},typeName:function(){return"oid"},getTimestamp:function(){return 1e3*parseInt(this._str.substr(0,8),16)},getMachineId:function(){return parseInt(this._str.substr(8,6),16)},getProcessId:function(){return parseInt(this._str.substr(14,4),16)},getCounter:function(){return parseInt(this._str.substr(18,6),16)},valueOf:function(){return this._str},toJSON:function(){return this._str},toHexString:function(){return this._str},_selectorIsId:function(a){return"string"==typeof a||"number"==typeof a||a instanceof g.LiveData.ObjectId},_selectorIsIdPerhapsAsObject:function(a){return this._selectorIsId(a)||a&&"object"==typeof a&&a._id&&this._selectorIsId(a._id)&&1===c.size(a)},_idsMatchedBySelector:function(a){if(this._selectorIsId(a))return[a];if(!a)return null;if(c.has(a,"_id"))return this._selectorIsId(a._id)?[a._id]:a._id&&a._id.$in&&c.isArray(a._id.$in)&&!c.isEmpty(a._id.$in)&&c.all(a._id.$in,this._selectorIsId)?a._id.$in:null;if(a.$and&&c.isArray(a.$and))for(var b=0;b<a.$and.length;++b){var d=this._idsMatchedBySelector(a.$and[b]);if(d)return d}return null}}),g.LiveData.UniqueId=g.LiveData._Object.design({uuid:function(a,b){var c="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),d=[];b=b||c.length;var e;if(a)for(e=0;a>e;e++)d[e]=c[0|Math.random()*b];else{var f;for(d[8]=d[13]=d[18]=d[23]="-",d[14]="4",e=0;36>e;e++)d[e]||(f=0|16*Math.random(),d[e]=c[19===e?3&f|8:f])}return d.join("")}}),g.LiveData.Base64=g.LiveData._Object.design({type:"Relution.LiveData.Base64",_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encodeBinary:function(a){for(var b,c="",d=new Array(4),e=0,f=0;e<a.length;){b=new Array(3);for(var g=0;g<b.length;g++)e<a.length?b[g]=255&a.charCodeAt(e++):b[g]=0;switch(d[0]=b[0]>>2,d[1]=(3&b[0])<<4|b[1]>>4,d[2]=(15&b[1])<<2|b[2]>>6,d[3]=63&b[2],f=e-(a.length-1)){case 2:d[3]=64,d[2]=64;break;case 1:d[3]=64}for(g=0;g<d.length;g++)c+=this._keyStr.charAt(d[g])}return c},encode:function(a){var b,c,d,e,f,h,i,j="",k=0;for(a=g.LiveData.Cypher.utf8Encode(a);k<a.length;)b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),e=b>>2,f=(3&b)<<4|c>>4,h=(15&c)<<2|d>>6,i=63&d,isNaN(c)?h=i=64:isNaN(d)&&(i=64),j+=this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return j},binaryEncode:function(a){for(var b,c,d,e,f,g,h,i="",j=0;j<a.length;)b=a.charCodeAt(j++),c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i+=this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decode:function(a){var b,c,d,e,f,h,i,j="",k=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");k<a.length;)e=this._keyStr.indexOf(a.charAt(k++)),f=this._keyStr.indexOf(a.charAt(k++)),h=this._keyStr.indexOf(a.charAt(k++)),i=this._keyStr.indexOf(a.charAt(k++)),b=e<<2|f>>4,c=(15&f)<<4|h>>2,d=(3&h)<<6|i,j+=String.fromCharCode(b),64!==h&&(j+=String.fromCharCode(c)),64!==i&&(j+=String.fromCharCode(d));return g.LiveData.Cypher.utf8Decode(j)}}),g.LiveData.SHA256=g.LiveData._Object.design({type:"Relution.LiveData.SHA256",chrsz:8,hexcase:0,hash:function(a){return a=g.LiveData.Cypher.utf8Encode(a),this.binb2hex(this.coreSha256(this.str2binb(a),a.length*this.chrsz))},safeAdd:function(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c},S:function(a,b){return a>>>b|a<<32-b},R:function(a,b){return a>>>b},Ch:function(a,b,c){return a&b^~a&c},Maj:function(a,b,c){return a&b^a&c^b&c},Sigma0256:function(a){return this.S(a,2)^this.S(a,13)^this.S(a,22)},Sigma1256:function(a){return this.S(a,6)^this.S(a,11)^this.S(a,25)},Gamma0256:function(a){return this.S(a,7)^this.S(a,18)^this.R(a,3)},Gamma1256:function(a){return this.S(a,17)^this.S(a,19)^this.R(a,10)},coreSha256:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),p=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),q=new Array(64);for(a[b>>5]|=128<<24-b%32,a[(b+64>>9<<4)+15]=b,k=0;k<a.length;k+=16){for(c=p[0],d=p[1],e=p[2],f=p[3],g=p[4],h=p[5],i=p[6],j=p[7],l=0;64>l;l++)16>l?q[l]=a[l+k]:q[l]=this.safeAdd(this.safeAdd(this.safeAdd(this.Gamma1256(q[l-2]),q[l-7]),this.Gamma0256(q[l-15])),q[l-16]),m=this.safeAdd(this.safeAdd(this.safeAdd(this.safeAdd(j,this.Sigma1256(g)),this.Ch(g,h,i)),o[l]),q[l]),n=this.safeAdd(this.Sigma0256(c),this.Maj(c,d,e)),j=i,i=h,h=g,g=this.safeAdd(f,m),f=e,e=d,d=c,c=this.safeAdd(m,n);p[0]=this.safeAdd(c,p[0]),p[1]=this.safeAdd(d,p[1]),p[2]=this.safeAdd(e,p[2]),p[3]=this.safeAdd(f,p[3]),p[4]=this.safeAdd(g,p[4]),p[5]=this.safeAdd(h,p[5]),p[6]=this.safeAdd(i,p[6]),p[7]=this.safeAdd(j,p[7])}return p},str2binb:function(a){for(var b=[],c=(1<<this.chrsz)-1,d=0;d<a.length*this.chrsz;d+=this.chrsz)b[d>>5]|=(a.charCodeAt(d/this.chrsz)&c)<<24-d%32;return b},binb2hex:function(a){for(var b=this.hexcase?"0123456789ABCDEF":"0123456789abcdef",c="",d=0;d<4*a.length;d++)c+=b.charAt(a[d>>2]>>8*(3-d%4)+4&15)+b.charAt(a[d>>2]>>8*(3-d%4)&15);return c}}),g.LiveData.Cypher=g.LiveData._Object.design({type:"Relution.LiveData.Cypher",defaultDecoder:g.LiveData.Base64,defaultEncoder:g.LiveData.Base64,defaultHasher:g.LiveData.SHA256,decode:function(a,b){return b&&b.decode?b.decode(a):this.defaultDecoder.decode(a)},encode:function(a,b){return b&&b.encode?b.encode(a):this.defaultEncoder.encode(a)},hash:function(a,b){return b&&b.hash?b.hash(a):this.defaultHasher.hash(a)},utf8Encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b},utf8Decode:function(a){var b,c,d,e,f,g="";for(b=c=d=e=0;b<a.length;)c=a.charCodeAt(b),128>c?(g+=String.fromCharCode(c),b++):c>191&&224>c?(e=a.charCodeAt(b+1),g+=String.fromCharCode((31&c)<<6|63&e),b+=2):(e=a.charCodeAt(b+1),f=a.charCodeAt(b+2),g+=String.fromCharCode((15&c)<<12|(63&e)<<6|63&f),b+=3);return g}}),g.LiveData.URLUtil=g.LiveData._Object.design({getLocation:function(a){var b=document.createElement("a");return b.href=a||this.url,""===b.host&&(b.href=b.href),b},resolveLocation:function(a){return this.getLocation(a).toString()},hashLocation:function(a){return this._hashCode(this.resolveLocation(a))},_hashCode:function(){for(var a=0,b=0;b<arguments.length;++b)for(var c=arguments[b]||"",d=0,e=c.length;e>d;++d){var f=c.charCodeAt(d);a=(a<<5)-a+f,a|=0}return a}});var g;!function(a){var b;!function(a){var b=function(){function a(a){this.expression=f.eval(null,a,{resultType:"PATH"})||a,this.simple=/^\w+$/.test(this.expression)}return a.prototype.evaluate=function(a,b){if(!b&&this.simple)return a&&a[this.expression];var c=f.eval(a,this.expression,b||{wrap:!1});return b||c!==!1||f.eval(a,this.expression,{resultType:"PATH",wrap:!1})?c:void 0},a}();a.JsonPath=b}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){var b=function(){function a(){}return a.prototype.visit=function(a){return this[a.type].apply(this,arguments)},a.prototype.logOp=function(a){return this[a.operation.toLowerCase()+"Op"].apply(this,arguments)},a}();a.FilterVisitorBase=b}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};!function(a){var b;!function(a){function b(a,b){return new d(b).visit(a)}a.jsonFilter=b;var d=function(b){function d(a){b.call(this),this.options={casesensitive:!1},a&&c.extend(this.options,a)}return h(d,b),d.prototype.containsString=function(b){var d=new a.JsonPath(b.fieldName),e=b.contains;if(void 0===e||null===e)return function(a){var b=d.evaluate(a);return void 0===b||null===b};var f;if(this.options.casesensitive)f=function(a){return a.toString().indexOf(e)>=0};else{var g=e.replace(/([\.\\\[\]\+\^\$\(\)\*\?\{\}\,\!])/g,"\\$1"),h=new RegExp(g,"i");f=function(a){return h.test(a.toString())}}return function(a){var b=d.evaluate(a);if(void 0===b||null===b)return!1;if(c.isArray(b)){for(var e=0;e<b.length;++e){var g=b[e];if(void 0!==g&&null!==g&&f(g))return!0}return!1}return f(b)}},d.prototype.string=function(b){var d=new a.JsonPath(b.fieldName),e=b.value;if(void 0===e||null===e)return function(a){var b=d.evaluate(a);return void 0===b||null===b};var f;if(this.options.casesensitive)f=function(a){return a==e};else{var g=e.replace(/([\.\\\[\]\+\^\$\(\)\*\?\{\}\,\!])/g,"\\$1"),h=new RegExp("^"+g+"$","i");f=function(a){return h.test(a.toString())}}return function(a){var b=d.evaluate(a);if(void 0===b||null===b)return!1;if(c.isArray(b)){for(var e=0;e<b.length;++e){var g=b[e];if(void 0!==g&&null!==g&&f(g))return!0}return!1}return f(b)}},d.prototype.range=function(b){var c=new a.JsonPath(b.fieldName),d=b.min,e=b.max;return void 0===d||null===d?void 0===e||null===e?function(a){var b=c.evaluate(a);return!!b}:function(a){var b=c.evaluate(a);return!!b&&e>=b}:d===e?function(a){var b=c.evaluate(a);return!!b&&b==d}:void 0===e||null===e?function(a){var b=c.evaluate(a);return!!b&&b>=d}:function(a){var b=c.evaluate(a);return!!b&&e>=b&&b>=d}},d.prototype.longRange=function(a){return this.range(a)},d.prototype.dateRange=function(a){return this.range(a)},d.prototype.stringRange=function(a){return this.range(a)},d.prototype.doubleRange=function(a){return this.range(a)},d.prototype["boolean"]=function(b){var c=new a.JsonPath(b.fieldName),d=b.value;return function(a){var b=c.evaluate(a);return!!b===d}},d.prototype["enum"]=function(b){var c=new a.JsonPath(b.fieldName),d=b.values;return d?function(a){var b=c.evaluate(a);return d.indexOf(b)>=0}:function(a){var b=c.evaluate(a);return!b}},d.prototype.stringEnum=function(a){return this["enum"](a)},d.prototype.longEnum=function(a){return this["enum"](a)},d.prototype.stringMap=function(b){var d,e=new a.JsonPath(b.fieldName),f=void 0!==b.key&&null!==b.key&&new a.JsonPath(b.key),g=b.value;if(void 0!==g&&null!==g)if(this.options.casesensitive)d=function(a){return a==g};else{var h=g.replace(/([\.\\\[\]\+\^\$\(\)\*\?\{\}\,\!])/g,"\\$1"),i=new RegExp("^"+h+"$","i");d=function(a){return i.test(a.toString())}}return f||d?f?void 0===g||null===g?function(a){var b=e.evaluate(a),c=f.evaluate(b);return void 0!==c&&null!==c}:function(a){var b=e.evaluate(a),c=f.evaluate(b);return void 0!==c&&null!==c&&d(c)}:function(a){var b=e.evaluate(a);if(b)for(var c in b){var f=b[c];if(void 0!==f&&null!==f&&d(f))return!0}return!1}:function(a){var b=e.evaluate(a);return b&&c.keys(b).length>0}},d.prototype.like=function(b){var d=new a.JsonPath(b.fieldName),e=b.like;if(void 0===e||null===e)return function(a){var b=d.evaluate(a);return void 0===b||null===b};var f,g=e.replace(/([\.\\\[\]\+\^\$\(\)\*\?\{\}\,\!])/g,"\\$1").replace(/%/g,".*");return f=this.options.casesensitive?new RegExp("^"+g+"$"):new RegExp("^"+g+"$","i"),function(a){var b=d.evaluate(a);if(void 0===b||null===b)return!1;if(c.isArray(b)){for(var e=0;e<b.length;++e){var g=b[e];if(f.test(g))return!0}return!1}return f.test(b)}},d.prototype["null"]=function(b){var c=new a.JsonPath(b.fieldName);return b.isNull?function(a){var b=c.evaluate(a);return void 0===b||null===b}:function(a){var b=c.evaluate(a);return void 0!==b&&null!==b}},d.prototype.filters=function(a){for(var b=new Array(a.filters.length),c=0;c<b.length;++c)b[c]=this.visit(a.filters[c]);return b},d.prototype.andOp=function(a){var b=this.filters(a);return function(a){for(var c=0;c<b.length;++c){var d=b[c];if(!d(a))return!1}return!0}},d.prototype.orOp=function(a){var b=this.filters(a);return function(a){for(var c=0;c<b.length;++c){var d=b[c];if(d(a))return!0}return!1}},d.prototype.nandOp=function(a){var b=this.filters(a);return function(a){for(var c=0;c<b.length;++c){var d=b[c];if(!d(a))return!0}return!1}},d.prototype.norOp=function(a){var b=this.filters(a);return function(a){for(var c=0;c<b.length;++c){var d=b[c];if(d(a))return!1}return!0}},d}(a.FilterVisitorBase)}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){var b=function(){function a(a){this.sortFields=a&&a.sortFields}return a.prototype.fromJSON=function(a){this.sortFields=new Array(a.length);for(var b=a.length-1;b>=0;--b)this.sortFields[b]=(new d).fromJSON(a[b]);return this},a.prototype.toString=function(){for(var a="",b=this.sortFields.length,c=0;b>c;++c)c>0&&(a+=","),a+=this.sortFields[c].toString();return a},a.prototype.merge=function(a){this.sortFields=this.sortFields.concat(a.sortFields)},a.prototype.optimize=function(){this.sortFields=c.unique(this.sortFields,!1,function(a){return a.name})},a}();a.SortOrder=b;var d=function(){function a(a){a&&(this.name=a.name,this.ascending=a.ascending)}return a.prototype.fromJSON=function(a){var b=a.length>0&&a.charAt(0);return this.name="+"===b||"-"===b?a.substring(1):a,this.ascending="-"!==b,this},a.prototype.toJSON=function(){return this.ascending?this.name:"-"+this.name},a.prototype.toString=function(){return this.ascending?"+"+this.name:"-"+this.name},a}();a.SortField=d}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){function b(b,e){var f;"string"==typeof b?(f=new a.SortOrder,f.fromJSON.apply(f,arguments)):c.isArray(b)?(f=new a.SortOrder,f.fromJSON.call(f,b)):f=b;var g=new d(f,e);return c.bind(g.compare,g)}a.jsonCompare=b;var d=function(){function b(b,d){this.sortOrder=b,this.options={casesensitive:!1},d&&c.extend(this.options,d),this.expressions=new Array(b.sortFields.length);for(var e=0;e<this.expressions.length;++e)this.expressions[e]=new a.JsonPath(b.sortFields[e].name)}return b.prototype.compare=function(a,b){for(var c=0;c<this.sortOrder.sortFields.length;++c){var d=this.expressions[c],e=d.evaluate(a),f=d.evaluate(b),g=this.compare1(e,f);if(0!==g)return this.sortOrder.sortFields[c].ascending?+g:-g}return 0},b.prototype.compare1=function(a,b){if(a&&b)if(Array.isArray(a)||Array.isArray(b))for(var c=Array.isArray(a)?a:[a],d=Array.isArray(b)?b:[b],e=Math.max(c.length,d.length),f=0;e>f;++f){var g=this.compare1(c[f],d[f]);if(0!==g)return g}else{if(this.options.casesensitive||("string"==typeof a&&(a=a.toLowerCase()),"string"==typeof b&&(b=b.toLowerCase())),b>a)return-1;if(a>b)return 1}else{if(b)return-1;if(a)return 1}return 0},b}()}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){var b=function(){function b(a){a&&(this.limit=a.limit,this.offset=a.offset,this.sortOrder=a.sortOrder,this.filter=a.filter,this.fields=a.fields)}return Object.defineProperty(b.prototype,"min",{get:function(){return 0|this.offset},set:function(a){var b=a&&0!==a?a:void 0;if(b!==this.offset){var c=this.max;this.offset=b,this.max=c}},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"max",{get:function(){return this.limit?this.limit+this.min:1/0},set:function(a){var b=a&&a!==1/0?a-this.min:void 0;if(b!==this.limit){var c=this.min;this.limit=b,this.min=c}},enumerable:!0,configurable:!0}),b.prototype.fromJSON=function(b){return this.limit=b.limit,this.offset=b.offset,this.sortOrder=b.sortOrder&&(new a.SortOrder).fromJSON(b.sortOrder),this.filter=b.filter,this.fields=b.fields,this},b.isAndFilter=function(a){return"logOp"===a.type&&"and"===a.operation},b.prototype.merge=function(b){this.min=Math.max(this.min,b.min),this.max=Math.min(this.max,b.max),this.sortOrder?b.sortOrder&&this.sortOrder.merge(b.sortOrder):this.sortOrder=b.sortOrder&&new a.SortOrder(b.sortOrder),this.filter?b.filter&&(this.filter={type:"logOp",operation:"and",filters:[this.filter,b.filter]}):this.filter=b.filter,this.fields?b.fields&&(this.fields=this.fields.concat(b.fields)):this.fields=b.fields},b.prototype.optimize=function(){if(this.sortOrder&&this.sortOrder.optimize(),this.filter&&b.isAndFilter(this.filter))for(var a=this.filter.filters,d=a.length-1;d>=0;--d)if(b.isAndFilter(a[d])){var e=a[d].filters;Array.prototype.splice.apply(a,Array.prototype.concat([d,1],e)),d+=e.length}this.fields&&(Array.prototype.sort.apply(this.fields),this.fields=c.unique(this.fields,!0))},b.prototype.toQueryParams=function(){var a="";if(this.limit&&(a+="&limit="+this.limit),this.offset&&(a+="&offset="+this.offset),this.sortOrder){var b=this.sortOrder.toString();b&&(a+="&sortOrder="+encodeURIComponent(b))}if(this.filter&&(a+="&filter="+encodeURIComponent(JSON.stringify(this.filter))),this.fields)for(var c=this.fields.length,d=0;c>d;++d)a+="&field="+this.fields[d];return a&&a.substr(1)},b}();a.GetQuery=b}(b=a.LiveData||(a.LiveData={}))}(g||(g={})),g.LiveData.Security=g.LiveData._Object.design({logon:c.extend(function j(a){var b=a&&a.credentials,c=b&&b.type,d=c&&j[c];return d?d.apply(this,arguments):e.resolve()},{basic:function(a){var b=a.credentials,c=b.username&&g.LiveData.Base64.encode(encodeURIComponent(b.username+":"+(b.password||"")));return c&&(a.beforeSend=function(a){a.setRequestHeader("Authorization","Basic "+c)}),e.resolve()}})});var g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};!function(a){var d;!function(d){function e(b){return"object"!=typeof b?!1:"isModel"in b?(a.assert(function(){return b.isModel===f.prototype.isPrototypeOf(b)}),b.isModel):f.prototype.isPrototypeOf(b)}d.isModel=e;var f=function(d){function e(a,b){d.call(this,a,b),this.defaults={},this.changedSinceSync={},this.urlRoot&&"string"==typeof this.urlRoot&&"/"!==this.urlRoot.charAt(this.urlRoot.length-1)&&(this.urlRoot+="/"),this.init(a,b)}return h(e,d),e.prototype.init=function(a,b){b=b||{},this.collection=b.collection||this.collection,this.idAttribute=b.idAttribute||this.idAttribute,this.store=this.store||(this.collection?this.collection.store:null)||b.store,this.store&&c.isFunction(this.store.initModel)&&this.store.initModel(this,b),this.entity=this.entity||(this.collection?this.collection.entity:null)||b.entity,this.credentials=this.credentials||(this.collection?this.collection.credentials:null)||b.credentials,this.on("change",this.onChange,this),this.on("sync",this.onSync,this)},e.prototype.ajax=function(b){return a.LiveData.ajax.apply(this,arguments)},e.prototype.sync=function(b,c,d){return a.LiveData.sync.apply(this,arguments)},e.prototype.onChange=function(a,b){var d=a.changedAttributes();if(c.isObject(d))for(var e in d)this.changedSinceSync[e]=d[e]},e.prototype.onSync=function(a,b){this.changedSinceSync={}},e.prototype.getUrlRoot=function(){if(this.urlRoot)return c.isFunction(this.urlRoot)?this.urlRoot():this.urlRoot;if(this.collection)return this.collection.getUrlRoot();if(this.url){var a=c.isFunction(this.url)?this.url():this.url;return a&&this.id&&a.indexOf(this.id)>0?a.substr(0,a.indexOf(this.id)):a}},e.extend=b.Model.extend,e.create=a.LiveData.create,e.design=a.LiveData.design,e}(b.Model);d.Model=f;var g=c.extend(f.prototype,d._Object,{_type:"Relution.LiveData.Model",isModel:!0,isCollection:!1});a.assert(function(){return e(g)})}(d=a.LiveData||(a.LiveData={}))}(g||(g={}));var g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};!function(a){var d;!function(d){function f(b){return"object"!=typeof b?!1:"isCollection"in b?(a.assert(function(){return b.isCollection===g.prototype.isPrototypeOf(b)}),b.isCollection):g.prototype.isPrototypeOf(b)}d.isCollection=f;var g=function(d){function f(a,b){d.call(this,a,b),this.url&&"/"!==this.url.charAt(this.url.length-1)&&(this.url+="/"),this.init(b)}return h(f,d),f.prototype.init=function(a,b){b=b||{},this.store=b.store||this.store||(this.model?this.model.prototype.store:null),this.entity=b.entity||this.entity||(this.model?this.model.prototype.entity:null),this.options=b.options||this.options,this.entity=this.entity||this.entityFromUrl(this.url),this._updateUrl(),this.store&&c.isFunction(this.store.initCollection)&&this.store.initCollection(this,b)},f.prototype.ajax=function(b){return a.LiveData.ajax.apply(this,arguments)},f.prototype.sync=function(b,c,d){return a.LiveData.sync.apply(this,arguments)},f.prototype.entityFromUrl=function(a){if(a){var b=document.createElement("a");b.href=a||this.url,""===b.host&&(b.href=b.href);var c=b.pathname.match(/([^\/]+)\/?$/);if(c&&c.length>1)return c[-1]}},f.prototype.destroy=function(a){a=a||{};var b=a.success;if(this.length>0){a.success=function(){0===this.length&&b&&b()};for(var c;c=this.first();)this.sync("delete",c,a),this.remove(c)}else b&&b()},f.prototype.save=function(){this.each(function(a){a.save()})},f.prototype.applyFilter=function(a){this.trigger("filter",this.filter(a))},f.prototype.getUrlParams=function(a){a=a||this.getUrl();var b=a.match(/\?([^#]*)/),d={};return b&&b.length>1&&c.each(b[1].split("&"),function(a){var b=a.split("=");d[b[0]]=b[1]}),d},f.prototype.getUrl=function(){return(c.isFunction(this.url)?this.url():this.url)||""},f.prototype.getUrlRoot=function(){var a=this.getUrl();return a.indexOf("?")>=0?a.substr(0,a.indexOf("?")):a},f.prototype._updateUrl=function(){if(this.options){var a=this.getUrlParams();if(this.url=this.getUrlRoot(),this.options.query&&(a.query=encodeURIComponent(JSON.stringify(this.options.query))),this.options.fields&&(a.fields=encodeURIComponent(JSON.stringify(this.options.fields))),this.options.sort&&(a.sort=encodeURIComponent(JSON.stringify(this.options.sort))),!c.isEmpty(a)){this.url+="?";var b=[];for(var d in a)b.push(d+(a[d]?"="+a[d]:""));this.url+=b.join("&")}}},f.prototype.fetchMore=function(a){return this.syncContext?this.syncContext.fetchMore(this,a):e.reject(new Error("no context"))},f.prototype.fetchNext=function(a){return this.syncContext?this.syncContext.fetchNext(this,a):e.reject(new Error("no context"))},f.prototype.fetchPrev=function(a){return this.syncContext?this.syncContext.fetchPrev(this,a):e.reject(new Error("no context"))},f.extend=b.Collection.extend,f.create=a.LiveData.create,f.design=a.LiveData.design,f}(b.Collection);d.Collection=g;var i=c.extend(g.prototype,d._Object,{_type:"Relution.LiveData.Collection",isModel:!1,isCollection:!0,model:d.Model});a.assert(function(){return f(i)})}(d=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var d;!function(d){var f=function(){function f(b){a.LiveData.Debug.trace("Store",b),b&&c.extend(this,b)}return f.prototype.getArray=function(a){return c.isArray(a)?a:d.isCollection(a)?a.models:c.isObject(a)?[a]:[]},f.prototype.getDataArray=function(a){var d=[];if(c.isArray(a)||b.Collection.prototype.isPrototypeOf(a))c.each(a,function(a){var b=this.getAttributes(a);b&&d.push(b)});else{var e=this.getAttributes(a);e&&d.push(this.getAttributes(e))}return d},f.prototype.getAttributes=function(a){return b.Model.prototype.isPrototypeOf(a)?a.attributes:c.isObject(a)?a:null},f.prototype.initModel=function(a,b){},f.prototype.initCollection=function(a,b){},f.prototype.sync=function(a,b,c){return e.reject(new Error("not implemented!"))},f.prototype.fetch=function(a,b){var d=c.extend({},b||{},{store:this});return a.fetch(d)},f.prototype.create=function(a,b,d){var e=c.extend({},d||{},{store:this});return a.create(b,e)},f.prototype.save=function(a,b,d){var e=c.extend({},d||{},{store:this});return a.save(b,e)},f.prototype.destroy=function(a,b){if(a&&a.destroy){var d=c.extend({},b||{},{store:this});a.destroy(d)}},f.prototype._checkData=function(b,d){if(!(c.isArray(d)&&0!==d.length||c.isObject(d))){var e=f.CONST.ERROR_NO_DATA;return a.LiveData.Debug.error(e),this.handleError(b,e),!1}return!0},f.prototype.handleSuccess=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];a.success&&this.handleCallback.apply(this,[a.success].concat(b)),a.finish&&this.handleCallback.apply(this,[a.finish].concat(b))},f.prototype.handleError=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];a.error&&this.handleCallback.apply(this,[a.error].concat(b)),a.finish&&this.handleCallback.apply(this,[a.finish].concat(b))},f.prototype.close=function(){},f.extend=d.extend,f.create=d.create,f.design=d.design,f.CONST={ERROR_NO_DATA:"No data passed. ",ERROR_LOAD_DATA:"Error while loading data from store. ",ERROR_SAVE_DATA:"Error while saving data to the store. ",ERROR_LOAD_IDS:"Error while loading ids from store. ",ERROR_SAVE_IDS:"Error while saving ids to the store. "},f}();d.Store=f;var g=c.extend(f.prototype,b.Events,d._Object,{_type:"Relution.LiveData.Store",isModel:!1,isCollection:!1,name:"relution-livedata"});a.assert(function(){return f.prototype.isPrototypeOf(g)})}(d=a.LiveData||(a.LiveData={}))}(g||(g={}));var g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};!function(a){var b;!function(b){var d=function(d){function f(a){if(d.call(this,a),this.db=null,this.entities={},a&&a.entities)for(var b in a.entities)this.entities[b]={table:a.entities[b]||b}}return h(f,d),f.prototype.sync=function(a,b,d){d=d||{};var f=this,g=e.defer(),h=c.extend({entity:b.entity||d.entity},d||{},{success:function(a){var b=f.handleSuccess(d,a)||a;return g.resolve(b),b},error:function(a){var b=f.handleError(d,a);return b?(g.resolve(b),b):void g.reject(a)}});switch(a){
case"create":f._checkTable(h,function(){f._insertOrReplace(b,h)});break;case"update":case"patch":f._checkTable(h,function(){f._insertOrReplace(b,h)});break;case"delete":f._checkTable(h,function(){f._delete(b,h)});break;case"read":f._checkTable(h,function(){f._select(b,h)})}return g.promise},f.prototype.select=function(a){this._select(null,a)},f.prototype.drop=function(a){this._dropTable(a)},f.prototype.createTable=function(a){this._createTable(a)},f.prototype.execute=function(a){this._executeSql(a)},f.prototype._sqlUpdateDatabase=function(a,b){var c=[];for(var d in this.entities)c.push(this._sqlDropTable(d)),c.push(this._sqlCreateTable(d));return c},f.prototype._sqlDropTable=function(a){return"DROP TABLE IF EXISTS '"+this.entities[a].table+"';"},f.prototype._sqlCreateTable=function(a){return"CREATE TABLE IF NOT EXISTS '"+this.entities[a].table+"' (id VARCHAR(255) NOT NULL PRIMARY KEY ASC UNIQUE, data TEXT NOT NULL);"},f.prototype._sqlDelete=function(b,c){var d="DELETE FROM '"+this.entities[c].table+"'",e=this._sqlWhereFromData(b,c);return e?d+=" WHERE "+e:a.assert(function(){return!1},"attempt of deletion without where clause"),d+=b.and?" AND "+b.and:""},f.prototype._sqlWhereFromData=function(a,b){if(a&&a.models&&b){var d=[],e=this;if(c.each(a.models,function(a){a.isNew()||d.push(e._sqlValue(a.id))}),d.length>0)return"id IN ("+d.join(",")+")"}return""},f.prototype._sqlSelect=function(a,b){if(a.syncContext){var c="SELECT ";return c+="*",c+=" FROM '"+this.entities[b].table+"'"}var c="SELECT ";c+="*",c+=" FROM '"+this.entities[b].table+"'";var d=this._sqlWhereFromData(a,b);return d&&(c+=" WHERE "+d),a.order&&(c+=" ORDER BY "+a.order),a.limit&&(c+=" LIMIT "+a.limit),a.offset&&(c+=" OFFSET "+a.offset),c},f.prototype._sqlValue=function(a){return a=c.isNull(a)?"null":c.isObject(a)?JSON.stringify(a):a.toString(),a=a.replace(/"/g,'""'),'"'+a+'"'},f.prototype._dropTable=function(a){var b=a.entity;if(b in this.entities&&this.entities[b].created!==!1){if(this._checkDb(a)){var c=this._sqlDropTable(b);this._executeTransaction(a,[c])}}else this.handleSuccess(a)},f.prototype._createTable=function(a){var b=a.entity;if(b in this.entities||(this.entities[b]={table:b}),this._checkDb(a)){var c=this._sqlCreateTable(b);this._executeTransaction(a,[c])}},f.prototype._checkTable=function(a,b){var c=this,d=a.entity;!d||this.entities[d]&&this.entities[d].created!==!1?b():this._createTable({success:function(){c.entities[d].created=!0,b()},error:function(b){c.handleError(a,b)},entity:d})},f.prototype._insertOrReplace=function(a,c){var d=c.entity,e=b.isCollection(a)?a.models:[a];if(this._checkDb(c)&&this._checkData(c,e)){for(var f=[],g="INSERT OR REPLACE INTO '"+this.entities[d].table+"' (",h=0;h<e.length;h++){var i=e[h],j="";i.id||i.set(i.idAttribute,(new b.ObjectID).toHexString());var k=c.attrs||i.attributes,l=["id","data"],m=[i.id,JSON.stringify(k)];if(m.length>0){var n=new Array(m.length).join("?,")+"?",o="'"+l.join("','")+"'";j+=g+o+") VALUES ("+n+");",f.push({statement:j,arguments:m})}}this._executeTransaction(c,f,a.toJSON())}},f.prototype._select=function(c,d){var e=d.entity;if(this._checkDb(d)){var f,g,h=!b.isModel(c);h?g=[]:d.models=[c];var i=this._sqlSelect(d,e),j=this;this.db.readTransaction(function(b){var c=i.statement||i,d=i.arguments;f=c,a.LiveData.Debug.info("sql statement: "+c),d&&a.LiveData.Debug.trace("arguments: "+JSON.stringify(d)),b.executeSql(c,d,function(a,b){for(var c=b.rows.length,d=0;c>d;d++){var e,f=b.rows.item(d);try{e=JSON.parse(f.data)}catch(i){j.trigger("error",i);continue}if(!h){g=e;break}g.push(e)}},function(b,c){a.LiveData.Debug.error("webSql error: "+c.message)})},function(b){a.LiveData.Debug.error("WebSql Syntax Error: "+b.message),j.handleError(d,b.message,f)},function(){g?(d.syncContext&&(g=d.syncContext.processAttributes(g,d)),j.handleSuccess(d,g)):j.handleError(d,"no result")})}},f.prototype._delete=function(a,c){var d=c.entity,e=b.isCollection(a)?a.models:[a];if(this._checkDb(c)){c.models=e;var f=this._sqlDelete(c,d);this._executeTransaction(c,[f],a.toJSON())}},f.prototype._executeSql=function(a){a.sql&&this._executeTransaction(a,[a.sql])},f.prototype._executeTransaction=function(b,d,e){var f,g;if(this._checkDb(b)){var h=this;try{this.db.transaction(function(b){c.each(d,function(c){var d=c.statement||c,e=c.arguments;g=d,a.LiveData.Debug.info("sql statement: "+d),e&&a.LiveData.Debug.trace("    arguments: "+JSON.stringify(e)),b.executeSql(d,e)})},function(c){a.LiveData.Debug.error(c.message),h.handleError(b,c.message,g)},function(){h.handleSuccess(b,e)})}catch(i){a.LiveData.Debug.error(i.message),f=i}}f&&this.handleError(b,f,g)},f.prototype._checkDb=function(b){if(!this.db){var c="db handler not initialized.";return a.LiveData.Debug.error(c),this.handleError(b,c),!1}return!0},f}(b.Store);b.AbstractSqlStore=d;var f=c.extend(d.prototype,{_type:"Relution.LiveData.AbstractSqlStore",size:1048576,version:"1.0"});a.assert(function(){return d.prototype.isPrototypeOf(f)})}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};!function(b){var d;!function(d){var e=function(d){function e(a){d.call(this,a);var c=this;this._openDb({error:function(a){b.LiveData.Debug.error(a),c.trigger("error",a)}})}return h(e,d),e.prototype._openDb=function(b){var c,d;if(!this.db)try{if(a.openDatabase){if(this.db=a.openDatabase(this.name,"","",this.size),this.entities)for(var e in this.entities)this._createTable({entity:e})}else c="Your browser does not support WebSQL databases."}catch(f){d=f}this.db?this.version&&this.db.version!==this.version?this._updateDb(b):this.handleSuccess(b,this.db):2===d||"2"===d?this._updateDb(b):(!c&&d&&(c=d),this.handleSuccess(b,c))},e.prototype._updateDb=function(d){var e,f,g=this;try{this.db||(this.db=a.openDatabase(this.name,"","",this.size));try{var h=this._sqlUpdateDatabase(this.db.version,this.version);this.db.changeVersion(this.db.version,this.version,function(a){c.each(h,function(c){b.LiveData.Debug.info("sql statement: "+c),f=c,a.executeSql(c)})},function(a){f||g.db.version!==g.options.version?g.handleError(d,a.message,f):g.handleSuccess(d,g.db)},function(){g.handleSuccess(d,g.db)})}catch(i){e=i.message,b.LiveData.Debug.error("webSql change version failed, DB-Version: "+this.db.version)}}catch(i){e=i.message}e&&this.handleError(d,e)},e.prototype.close=function(){b.LiveData.Debug.info("WebSQL Store close"),this.db&&(this.db=null)},e}(d.AbstractSqlStore);d.WebSqlStore=e;var f=c.extend(e.prototype,{_type:"Relution.LiveData.WebSqlStore"});b.assert(function(){return e.prototype.isPrototypeOf(f)})}(d=b.LiveData||(b.LiveData={}))}(g||(g={}));var g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};!function(b){var d;!function(d){var e=function(c){function d(a){if(c.call(this,a),a&&!a.security)throw new Error("security Key is required on a CipherSqlStore");b.LiveData.Debug.trace("CipherSqlStore",a);var d=this;this._openDb({error:function(a){b.LiveData.Debug.error(a),d.trigger("error",a)}})}return h(d,c),d.prototype._openDb=function(c){var d,e;if(!this.security)return b.LiveData.Debug.error("A CipherSqlStore need a Security Token!",this);if(!this.db)try{if(a.sqlitePlugin){if(this.db=a.sqlitePlugin.openDatabase({name:this.name,key:this.security,location:2}),this.entities)for(var f in this.entities)this._createTable({entity:f})}else d="Your browser does not support SQLite plugin."}catch(g){e=g}this.db?this.version&&this.db.version!==this.version?this._updateDb(c):this.handleSuccess(c,this.db):2===e||"2"===e?this._updateDb(c):(!d&&e&&(d=e),this.handleSuccess(c,d))},d.prototype._updateDb=function(c){var d;try{this.db||(this.db=a.sqlitePlugin.openDatabase({name:this.name,key:this.security,location:2}));try{this._sqlUpdateDatabase(this.db.version,this.version);b.LiveData.Debug.warning("sqlcipher cant change the version its still not supported check out https://github.com/litehelpers/Cordova-sqlcipher-adapter#other-limitations")}catch(e){d=e.message,b.LiveData.Debug.error("webSql change version failed, DB-Version: "+this.db.version)}}catch(e){d=e.message}d&&this.handleError(c,d)},d.prototype.close=function(){this.db&&this.db.close()},d}(d.AbstractSqlStore);d.CipherSqlStore=e;var f=c.extend(e.prototype,{_type:"Relution.LiveData.CipherSqlStore",security:null});b.assert(function(){return e.prototype.isPrototypeOf(f)})}(d=b.LiveData||(b.LiveData={}))}(g||(g={}));var g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};!function(a){var b;!function(b){var d=function(a){function b(){a.apply(this,arguments)}return h(b,a),b}(b.Model);b.LiveDataMessageModel=d;var e=c.extend(d.prototype,{_type:"Relution.LiveData.LiveDataMessageModel",entity:"__msg__",idAttribute:"_id"});a.assert(function(){return"check"===new e({_id:"check"}).id})}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(a){var b=function(){function b(b){this.isConnected=null,this.entity=b.entity,this.modelType=b.modelType,this.urlRoot=b.urlRoot,this.socketPath=b.socketPath,this.credentials=b.credentials;var c=a.URLUtil.getLocation(b.urlRoot);this.host=c.protocol+"//"+c.host,this.path=c.pathname;var d=b.entity,e=b.credentials&&b.credentials.username?b.credentials.username:"",f=a.URLUtil.hashLocation(b.urlRoot);this.channel=d+e+f}return b.prototype.close=function(){this.socket&&(this.socket.socket.close(),this.socket=null),this.localStore&&(this.localStore.close(),this.localStore=null)},b}();a.SyncEndpoint=b}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g,h=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)};!function(a){var b;!function(b){var d=function(d){function f(b){d.call(this,b),this.endpoints={},this.disconnectedEntity="all",this.credentials&&(this.credentials=c.clone(this.credentials)),this.localStoreOptions&&(this.localStoreOptions=c.clone(this.localStoreOptions)),this.orderOfflineChanges&&(this.orderOfflineChanges=c.clone(this.orderOfflineChanges)),a.LiveData.Debug.trace("SyncStore",b),this.useSocketNotify&&"object"!=typeof io&&(a.LiveData.Debug.warning("Socket.IO not present !!"),this.useSocketNotify=!1)}return h(f,d),f.prototype.initEndpoint=function(d,e){var f=d.getUrlRoot(),g=d.entity;if(f&&g){var h=d.credentials||this.credentials,i=this.endpoints[g];return i?(a.assert(function(){return i.urlRoot===f},"can not change urlRoot, must recreate store instead!"),a.assert(function(){return JSON.stringify(i.credentials)===JSON.stringify(h)},"can not change credentials, must recreate store instead!")):(a.LiveData.Debug.info("Relution.LiveData.SyncStore.initEndpoint: "+name),i=new b.SyncEndpoint({entity:g,modelType:e,urlRoot:f,socketPath:this.socketPath,credentials:h}),this.endpoints[g]=i,i.localStore=this.createLocalStore(i),i.priority=this.orderOfflineChanges&&c.lastIndexOf(this.orderOfflineChanges,i.entity)+1,this.createMsgCollection(),i.socket=this.createSocket(i,g),i.info=this.fetchServerInfo(i)),i}},f.prototype.initModel=function(a){a.endpoint=this.initEndpoint(a,a.constructor)},f.prototype.initCollection=function(a){a.endpoint=this.initEndpoint(a,a.model)},f.prototype.getEndpoint=function(c){var d=this.endpoints[c.entity];return d?(a.assert(function(){var a=b.isCollection(c)?c.model:c.constructor;return a===d.modelType||a.prototype instanceof d.modelType},"wrong type of model!"),d):void 0},f.prototype.createLocalStore=function(a){if(this.useLocalStore){var b={};b[a.entity]=a.channel;var d={entities:b};return this.localStoreOptions&&"object"==typeof this.localStoreOptions&&(d=c.clone(this.localStoreOptions),d.entities=b),new this.localStore(d)}},f.prototype.createMsgCollection=function(){return this.useOfflineChanges&&!this.messages&&(this.messages=b.Collection.design({model:b.LiveDataMessageModel,store:new this.localStore(this.localStoreOptions)})),this.messages},f.prototype.createSocket=function(c,d){var e=this;if(this.useSocketNotify&&c&&c.socketPath){a.LiveData.Debug.trace("Relution.LiveData.SyncStore.createSocket: "+d);var f=c.host,g=c.path,h=b.URLUtil.getLocation(f);""===h.port&&("https:"===h.protocol?f+=":443":"http:"===h.protocol&&(f+=":80")),g=c.socketPath;var i=g&&0===g.indexOf("/")?g.substr(1):g,j={resource:i};return this.socketQuery&&(j.query=this.socketQuery),c.socket=io.connect(f,j),c.socket.on("connect",function(){return e._bindChannel(c,d),e.onConnect(c).done()}),c.socket.on("disconnect",function(){return a.LiveData.Debug.info("socket.io: disconnect"),e.onDisconnect(c).done()}),c.socket.on(c.channel,function(a){return e.onMessage(c,e._fixMessage(c,a))}),c.socket}},f.prototype._bindChannel=function(b,c){if(b&&b.socket){a.LiveData.Debug.trace("Relution.LiveData.SyncStore._bindChannel: "+c);var d=b.channel,e=b.socket,f=this.getLastMessageTime(d);c=c||b.entity,e.emit("bind",{entity:c,channel:d,time:f})}},f.prototype.getLastMessageTime=function(a){if(this.lastMesgTime){if(void 0!==this.lastMesgTime[a])return this.lastMesgTime[a]}else this.lastMesgTime={};var b=localStorage.getItem("__"+a+"lastMesgTime")||0;return this.lastMesgTime[a]=b,b},f.prototype.setLastMessageTime=function(a,b){(!b||b>this.getLastMessageTime(a))&&(localStorage.setItem("__"+a+"lastMesgTime",b),this.lastMesgTime[a]=b)},f.prototype.onConnect=function(a){var b=this;if(!a.isConnected){var c=e.resolve(void 0);this.messagesPromise&&this.messagesPromise.isPending()&&(c=this.messagesPromise["catch"](function(a){return e.resolve(void 0)})),a.isConnected=c.then(function(){return b.fetchChanges(a).then(function(){return("all"===b.disconnectedEntity||b.disconnectedEntity===a.entity)&&(b.messagesPromise=null,b.disconnectedEntity=null),b._sendMessages()})["catch"](function(c){return c?e.reject(c):b.onDisconnect(a)})})["finally"](function(){a.isConnected&&b.trigger("connect:"+a.channel)})}return a.isConnected},f.prototype.onDisconnect=function(a){var b=this;return a.isConnected?(a.isConnected=null,this.disconnectedEntity||(this.disconnectedEntity="all"),e.fcall(function(){return void(a.socket&&a.socket.socket&&a.socket.socket.onDisconnect())})["finally"](function(){a.isConnected||b.trigger("disconnect:"+a.channel)})):e.resolve(void 0)},f.prototype._fixMessage=function(b,c){var d=b.modelType.prototype.idAttribute;return a.assert(function(){return!!d},"no idAttribute!"),c.data&&!c.data[d]&&c.data._id?c.data[d]=c.data._id:!c.data&&"delete"===c.method&&c[d]&&(c.data={},c.data[d]=c[d]),c},f.prototype.onMessage=function(b,d){var f=this;if(!d||!d.method)return e.reject(new Error("no message or method given"));var g,h=b.channel;if(b.localStore){var i=c.defaults({store:b.localStore},this.localStoreOptions),j=new b.modelType(d.data,c.extend({parse:!0},i));j.id?a.LiveData.Debug.debug("onMessage: "+b.entity+" "+j.id+" performing "+d.method):a.LiveData.Debug.error("onMessage: "+b.entity+" received data with no valid id performing "+d.method+"!"),g=b.localStore.sync(d.method,j,c.extend(i,{merge:"patch"===d.method})).then(function(c){if(!d.id||d.id===j.id)return c;var e={};e[j.idAttribute]=d.id;var f=new b.modelType(e,i);return a.LiveData.Debug.debug("onMessage: "+b.entity+" "+j.id+" reassigned from old record "+f.id),b.localStore.sync("delete",f,i)})}else g=e.resolve(d);return g.then(function(){return d.time&&f.setLastMessageTime(h,d.time),f.trigger("sync:"+h,d),d},function(a){return f.trigger("error:"+h,a,j),d})},f.prototype.sync=function(d,f,g){var h=this;a.LiveData.Debug.trace("Relution.LiveData.SyncStore.sync"),g=g||{};try{var i=f.endpoint||this.getEndpoint(f);if(!i)throw new Error("no endpoint");if(b.isCollection(f)){if("read"===d&&!g.barebone){var j=g.syncContext;j||(j=new b.SyncContext(g,f.options,this),g.syncContext=j),f.syncContext!==j&&(f.syncContext&&f.stopListening(this,"sync:"+i.channel),f.listenTo(this,"sync:"+i.channel,c.bind(j.onMessage,j,this,f)),f.syncContext=j)}}else{if(!b.isModel(f)){var k=new Error("target of sync is neither a model nor a collection!?!");return e.reject(this.handleError(g,k)||k)}if(!f.id){if("create"!==d){var k=new Error("no (valid) id: "+f.id);return e.reject(this.handleError(g,k)||k)}f.set(f.idAttribute,(new b.ObjectID).toHexString())}}var l=i.channel,m=this.getLastMessageTime(l);if("read"===d&&i.localStore&&m&&!g.reset){var n=c.clone(g);return n.store=i.localStore,n.entity=i.entity,delete n.success,delete n.error,i.localStore.sync(d,f,n).then(function(a){if(a=h.handleSuccess(g,a)||a,i.socket||"local"===g.fetchMode)return a;if(!i.isConnected){var b=h.fetchServerInfo(i);return b?b.then(function(a){var b;return i.isConnected||(b=h.onConnect(i)),b||a},function(b){var c;return!b.responseText&&i.isConnected&&(c=h.onDisconnect(i)),c||a}).thenResolve(a):a}return h.fetchChanges(i)["catch"](function(b){return!b.responseText&&i.isConnected?h.onDisconnect(i)||a:(h.trigger("error:"+l,b.responseJSON||b.responseText,f),a)}).thenResolve(a)},function(){return h._addMessage(d,f,g,i)})}return this._addMessage(d,f,g,i)}catch(k){return e.reject(this.handleError(g,k)||k)}},f.prototype._addMessage=function(b,d,f,g){var h=this;if(b&&d){var i=d.changedSinceSync,j=null,k=!0;switch(b){case"update":case"create":j=f.attrs||d.toJSON();break;case"patch":if(c.isEmpty(i))return;j=d.toJSON({attrs:i});break;case"delete":break;default:a.assert(function(){return"read"===b},"unknown method: "+b),k=!1}var l=d.entity||g.entity;a.assert(function(){return d.entity===g.entity}),a.assert(function(){return l.indexOf("~")<0},"entity name must not contain a ~ character!");var m,n={_id:l+"~"+d.id,id:d.id,method:b,data:j,priority:g.priority,time:Date.now()},o=e.resolve(n);return k&&(m=this.storeMessage(g,o),o=m.then(function(a){return a.attributes})),o.then(function(a){return h._emitMessage(g,a,f,d,m)})}},f.prototype._emitMessage=function(a,b,c,d,f){var g=this,h=a.channel,i=this._ajaxMessage(a,b,c,d),j=i;return f&&(j=j.then(function(c){return g.removeMessage(a,b,f).then(c,function(a){return g.trigger("error:"+h,a,d),c}).thenResolve(c)},function(c){return c?g.removeMessage(a,b,f).then(c,function(a){return g.trigger("error:"+h,a,d),c}).thenReject(c):e.resolve(b.data)})),j=this._applyResponse(j,a,b,c,d),j["finally"](function(){return i.then(function(){return a.isConnected?void 0:g.onConnect(a)},function(b){return!b&&a.isConnected?g.onDisconnect(a):void 0})})},f.prototype._ajaxMessage=function(d,f,g,h){var i=this;g=g||{};var j=g.url;if(!j&&(j=d.urlRoot,f.id&&"create"!==f.method&&(j+=("/"===j.charAt(j.length-1)?"":"/")+f.id),"read"===f.method&&b.isCollection(h))){var k=c.isFunction(h.url)?h.url():h.url,l=k.lastIndexOf("?"),m=(new b.GetQuery).fromJSON(g);m.limit=null,m.offset=null,m.filter=null,m.fields=null;var n=m.toQueryParams();l>=0?(j+=k.substr(l),n&&(j+="&"+n)):n&&(j+="?"+n)}a.LiveData.Debug.trace("ajaxMessage "+f.method+" "+j);var o={url:j,attrs:f.data,store:{},credentials:g.credentials,error:g.error};return delete g.xhr,h.sync(f.method,h,o).then(function(a){return g.xhr=o.xhr.xhr||o.xhr,a},function(a){return g.xhr=o.xhr.xhr||o.xhr,!a.responseText&&i.useOfflineChanges?e.reject():e.isPromise(a)?a:e.reject(a)})},f.prototype._applyResponse=function(d,f,g,h,i){var j=this,k=(f.channel,(new Date).getTime());return d.then(function(d){if(d||"delete"!==g.method||(d=g.data),d){var h,k=[];if("read"!==g.method)k.push(j.onMessage(f,j._fixMessage(f,d===g.data?g:c.defaults({data:d},g))));else if(b.isCollection(i)&&Array.isArray(d)){var l={};i.models.forEach(function(a){l[a.id]=a}),h={},d.forEach(function(a){if(a){var b=a[f.modelType.prototype.idAttribute]||a._id;h[b]=a;var d=l[b];d?(delete l[b],c.isEqual(c.pick.call(d,d.attributes,Object.keys(a)),a)||k.push(j.onMessage(f,j._fixMessage(f,{id:b,method:"update",time:g.time,data:a})))):k.push(j.onMessage(f,j._fixMessage(f,{id:b,method:"create",time:g.time,data:a})))}}),Object.keys(l).forEach(function(a){var b=l[a];k.push(j.onMessage(f,j._fixMessage(f,{id:a,method:"delete",time:g.time,data:b.attributes})))})}else for(var m=Array.isArray(d)?d:[d],n=0;n<m.length;n++)d=m[n],d&&k.push(j.onMessage(f,j._fixMessage(f,{id:d[f.modelType.prototype.idAttribute]||d._id,method:"update",time:g.time,data:d})));return e.all(k).then(function(){if(!h)return d;a.assert(function(){return b.isCollection(i)});for(var c=[],e=b.isCollection(i)?i.models:[i],f=e.length;f-->0;){var g=e[f];if(h[g.id]&&(c.push(g.attributes),delete h[g.id],h.length<=0))break}return c.reverse()})}}).then(function(a){return"read"===g.method&&b.isCollection(i)&&j.setLastMessageTime(f.channel,k),j.handleSuccess(h,a)||a},function(a){return j.handleError(h,a)||e.reject(a)})},f.prototype.fetchChanges=function(b,c){var d=this,f=b.channel;if(!b.urlRoot||!f)return e.resolve(void 0);var g=Date.now(),h=b.promiseFetchingChanges;if(h&&!c&&(h.isPending()||g-b.timestampFetchingChanges<1e3))return a.LiveData.Debug.warning(f+" skipping changes request..."),h;var i=this.getLastMessageTime(f);if(!i)return a.LiveData.Debug.error(f+" can not fetch changes at this time!"),h||e.resolve(void 0);a.LiveData.Debug.info(f+" initiating changes request...");var j=new this.messages.constructor;return h=e(j.fetch({url:b.urlRoot+"changes/"+i,credentials:b.credentials,store:{},success:function(a,c,e){return j.models.length>0?j.each(function(a){var c=a.attributes;d.onMessage(b,d._fixMessage(b,c))}):d.setLastMessageTime(f,g),c||e.xhr}})).thenResolve(j),b.promiseFetchingChanges=h,b.timestampFetchingChanges=g,h},f.prototype.fetchServerInfo=function(c){var d=this;if(c&&c.urlRoot){var f=Date.now(),g=c.promiseFetchingServerInfo;if(g&&(g.isPending()||f-c.timestampFetchingServerInfo<1e3))return a.LiveData.Debug.warning(c.channel+" skipping info request..."),g;var h=new b.Model,i=this.getLastMessageTime(c.channel),j=c.urlRoot;return"/"!==j.charAt(j.length-1)&&(j+="/"),g=e(h.fetch({url:j+"info",success:function(a,b,e){if(!i&&h.get("time")&&d.setLastMessageTime(c.channel,h.get("time")),!c.socketPath&&h.get("socketPath")){c.socketPath=h.get("socketPath");var f=h.get("entity")||c.entity;d.useSocketNotify&&(c.socket=d.createSocket(c,f))}return b||e.xhr},credentials:c.credentials})).thenResolve(h),c.promiseFetchingServerInfo=g,c.timestampFetchingServerInfo=f,g}},f.prototype.processOfflineMessageResult=function(c,d,f){var g=this;if(!c){if(!this.useSocketNotify){var h=this.endpoints[f.entity];if(h)return this.fetchChanges(h,!0)}return e.resolve(d)}if(!f.localStore)return e.reject(c);var i=f.modelType||b.Model,j=new i(d.get("data"),{entity:f.entity});j.id="create"!==d.get("method")&&d.get("id");var k=function(){var b=d.get("channel");a.LiveData.Debug.error("Relution.LiveData.SyncStore.processOfflineMessageResult: triggering error for channel "+b+" on store",c),f.silent||g.trigger("error:"+b,c,j)},l={store:f.localStore},m={urlRoot:f.urlRoot,store:{}};return j.id?(m.url=m.urlRoot+("/"===m.urlRoot.charAt(m.urlRoot.length-1)?"":"/")+j.id,a.assert(function(){return j.url()===m.url}),j.fetch(m).then(function(a){return j.save(a,l)["finally"](k)},function(a){var b=a&&a.status;switch(b){case 404:case 401:case 410:return j.destroy(l);default:return e.reject(a)["finally"](k)}})):(a.assert(function(){return"create"===d.get("method")}),j.destroy(l)["finally"](k))},f.prototype._sendMessages=function(){var c=this;if(!this.messages)return e.resolve(void 0);var d=function(){if(!c.messages.length)return c.messages;var f=c.messages.models[0],g=f.id.substr(0,f.id.indexOf("~"));if(!g)return a.LiveData.Debug.error("sendMessage "+f.id+" with no entity!"),f.destroy().then(d);var h=c.endpoints[g];if(!h)return c.messages;a.assert(function(){return h.channel===f.get("channel")},"channel of endpoint "+h.channel+" does not match channel of message "+f.get("channel"));var i=c._fixMessage(h,f.attributes),j=h.modelType||b.Model,k=new j(i.data,{entity:h.entity});k.id="create"!==f.get("method")&&f.get("id");var l={urlRoot:h.urlRoot,store:{}};k.id&&(l.url=l.urlRoot+("/"===l.urlRoot.charAt(l.urlRoot.length-1)?"":"/")+k.id,a.assert(function(){return k.url()===l.url})),a.LiveData.Debug.info("sendMessage "+k.id);var m={entity:h.entity,modelType:h.modelType,urlRoot:h.urlRoot,localStore:h.localStore};return c._applyResponse(c._ajaxMessage(h,i,l,k),h,i,l,k).then(function(){return c.processOfflineMessageResult(null,f,m)},function(a){return a?e(c.processOfflineMessageResult(a,f,m))["catch"](function(a){return c.disconnectedEntity=h.entity,c.onDisconnect(h).thenReject(a)}):e.reject()}).then(function(){return f.destroy()}).then(d)};a.LiveData.Debug.info("Relution.LiveData.SyncStore._sendMessages");var f=this.messagesPromise;if(f){if(this.messagesPromise.isRejected())return this.messagesPromise;if(!this.messages.length)return this.messagesPromise}else f=e(this.messages.fetch({sortOrder:["-priority","+time","+id"]}));return this.messagesPromise=f.then(d),this.messagesPromise},f.prototype.storeMessage=function(b,c){var d=this;return c.then(function(c){var f,g=d.messages.modelId(c);a.LiveData.Debug.info("storeMessage "+g);var h=g&&d.messages.get(g);return h?f={merge:!0}:(h=new d.messages.model(c,{collection:d.messages,store:d.messages.store}),h.set("channel",b.channel)),e(h.save(c,f)).thenResolve(h)})},f.prototype.removeMessage=function(b,c,d){var f=this;return d.then(function(b){if(!b){var d=f.messages.modelId(c);if(!d)return e.resolve(void 0);b=f.messages.get(d),b||(b=new f.messages.model({_id:c._id},{collection:f.messages,store:f.messages.store}))}return a.LiveData.Debug.trace("removeMessage "+b.id),b.destroy()})},f.prototype.clear=function(a){if(a){var b=this.getEndpoint(a);b&&(this.messages&&this.messages.destroy(),a.reset(),this.setLastMessageTime(b.channel,""))}},f.prototype.close=function(){this.messages.store&&(this.messages.store.close(),this.messages=null);for(var a=Object.keys(this.endpoints),b=0,c=a.length;c>b;b++)this.endpoints[a[b]].close()},f}(b.Store);b.SyncStore=d;var f=c.extend(d.prototype,{_type:"Relution.LiveData.SyncStore",localStore:b.WebSqlStore,useLocalStore:!0,useSocketNotify:!0,useOfflineChanges:!0,socketPath:""});a.assert(function(){return d.prototype.isPrototypeOf(f)})}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var g;!function(a){var b;!function(b){var d=function(){function d(){for(var a=this,c=[],d=0;d<arguments.length;d++)c[d-0]=arguments[d];this.getQuery=new b.GetQuery,c.forEach(function(c){c&&a.getQuery.merge((new b.GetQuery).fromJSON(c))}),this.getQuery.optimize(),this.pageSize=this.getQuery.limit,this.compareFn=this.getQuery.sortOrder&&b.jsonCompare(this.getQuery.sortOrder),this.filterFn=this.getQuery.filter&&b.jsonFilter(this.getQuery.filter)}return d.prototype.fetchMore=function(a,d){var e=this.getQuery;d=c.defaults(d||{},{limit:d.pageSize||this.pageSize||e.limit,sortOrder:e.sortOrder,filter:e.filter,fields:e.fields}),d.offset=(0|e.offset)+a.models.length,d.syncContext=this;var f=d.success,g=d.error;return d.success=function(b){return d.success=f,d.error=g,b&&(b.length<=0?delete d.more:(d.syncContext.compareFn&&(d.at=d.syncContext.insertionPoint(b[0],a.models)),b=a.add(b,d)||b,e.limit=a.models.length,d.syncContext.getQuery.limit>e.limit?delete d.more:(d.more=!0,delete d.end)),d.more||(e.limit=void 0,d.end=!0)),d.syncContext.getQuery=e,d.success&&(b=d.success.call(this,a,b,d)||b),d.finish&&(b=d.finish.call(this,a,b,d)||b),b},d.error=function(b){return d.success=f,d.error=g,d.syncContext.getQuery=e,d.error&&(b=d.error.call(this,a,b,d)||b),d.finish&&(b=d.finish.call(this,a,b,d)||b),b},this.getQuery=new b.GetQuery(e),this.getQuery.limit=e.limit+d.limit,a.sync(d.method||"read",a,d)},d.prototype.fetchRange=function(a,c){c=c||{},c.syncContext=this;var d=this.getQuery,e=new b.GetQuery(d);c.offset>=0?e.offset=c.offset:c.offset<0&&(e.offset=void 0);var f=c.limit;c.limit>0?(e.limit=c.limit+1,c.limit=e.limit):c.limit<=0&&(e.limit=void 0);var g=c.success,h=c.error;return c.success=function(b){return c.success=g,c.error=h,void 0!==f&&(c.limit=f),b&&(b.length>0?(c.next=e.limit&&b.length>=e.limit,c.next&&(b.length=b.length-1),b=a.reset(b,c)||b):delete c.next,c.prev=e.offset>0),c.success&&(b=c.success.call(this,a,b,c)||b),c.finish&&(b=c.finish.call(this,a,b,c)||b),b},c.error=function(b){return c.success=g,c.error=h,void 0!==f&&(c.limit=f),c.syncContext.getQuery=d,c.error&&(b=c.error.call(this,a,b,c)||b),c.finish&&(b=c.finish.call(this,a,b,c)||b),b},this.getQuery=e,a.sync(c.method||"read",a,c)},d.prototype.fetchNext=function(a,b){return b=b||{},b.limit=b.pageSize||this.pageSize||this.getQuery.limit,b.offset=(0|this.getQuery.offset)+a.models.length,this.fetchRange(a,b)},d.prototype.fetchPrev=function(a,b){return b=b||{},b.limit=b.pageSize||this.pageSize||this.getQuery.limit,b.offset=(0|this.getQuery.offset)-b.limit,this.fetchRange(a,b)},d.prototype.filterAttributes=function(a,b){return this.filterFn?a.filter(this.filterFn):a},d.prototype.sortAttributes=function(a,b){return this.compareFn?a.sort(this.compareFn):a},d.prototype.rangeAttributes=function(a,b){var c=b&&b.offset||this.getQuery.offset;c>0&&a.splice(0,c);var d=b&&b.limit||this.getQuery.limit;return d<a.length&&(a.length=d),a},d.prototype.processAttributes=function(a,b){return a=this.filterAttributes(a,b),a=this.sortAttributes(a,b),a=this.rangeAttributes(a,b)},d.prototype.onMessage=function(b,c,d){var e={collection:c,entity:c.entity,merge:"patch"===d.method,parse:!0,fromMessage:!0},f=c.modelId(d.data),g=d.id||f;if("all"===g)return void c.reset(d.data||{},e);var h=g&&c.get(g);switch(d.method){case"create":case"update":if(f!==g&&a.LiveData.Debug.warn("updating id "+g+" to "+f),!h){if(h=new e.collection.model(d.data,e),this.filterFn&&!this.filterFn(h.attributes))break;if(h.validationError)c.trigger("invalid",this,h.validationError,e);else{var i=c.models.length;this.compareFn&&i>0&&(e.at=i=this.insertionPoint(h.attributes,c.models)),this.getQuery.offset>0&&!(i>0)||i>=this.getQuery.limit||(c.add(h,e),this.getQuery.limit&&c.models.length>this.getQuery.limit&&c.remove(c.models[c.models.length-1],e))}break}case"patch":if(h)if(h.set(d.data,e),this.filterFn&&!this.filterFn(h.attributes))c.remove(h,e);else if(this.compareFn){var j=c.models.indexOf(h);this.lastInsertionPoint=j>=0?j:void 0;var k=this.insertionPoint(h.attributes,c.models);j!==k&&(c.models.splice(j,1),c.models.splice(k,0,h),c.trigger("sort",c,e))}break;case"delete":h&&c.remove(h,e)}},d.prototype.insertionPoint=function(a,b){if(void 0!==this.lastInsertionPoint){var c=Math.max(0,this.lastInsertionPoint),d=Math.min(b.length,this.lastInsertionPoint+3);if(d-c>1){var e=this.insertionPointBinarySearch(a,b,c,d);return e>=d?e<b.length&&(e=this.insertionPointBinarySearch(a,b,e,b.length)):c>e&&e>0&&(e=this.insertionPointBinarySearch(a,b,0,e)),this.lastInsertionPoint=e,e}}return this.lastInsertionPoint=this.insertionPointBinarySearch(a,b,0,b.length),this.lastInsertionPoint},d.prototype.insertionPointBinarySearch=function(a,b,c,d){var e=c+d>>1,f=this.compareFn(a,b[e].attributes);return 1>=d-c?0>f?e:e+1:0>f?this.insertionPointBinarySearch(a,b,c,e):f>0?++e<d?this.insertionPointBinarySearch(a,b,e,d):void 0:e},d}();b.SyncContext=d}(b=a.LiveData||(a.LiveData={}))}(g||(g={}));var i=null;a.Relution&&(i=a.Bikini=g.LiveData,i.BikiniStore=g.LiveData.SyncStore)}(this,Backbone,_,$,Q,jsonPath);
//# sourceMappingURL=bikini.map